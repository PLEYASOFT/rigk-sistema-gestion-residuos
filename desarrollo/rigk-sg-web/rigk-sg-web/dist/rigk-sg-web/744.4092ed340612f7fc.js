"use strict";(self.webpackChunkrigk_sg_web=self.webpackChunkrigk_sg_web||[]).push([[744],{9821:(de,w,p)=>{p.d(w,{d:()=>e});var S=p(2340),U=p(529),D=p(8256);let e=(()=>{class v{constructor(s){this.http=s,this.url=`${S.N.API_V1_URL}/establishment`}getAllEstablishment(){return this.http.get(`${this.url}/all/`)}getInovice(s,b,E,r){return this.http.post(`${this.url}/get/invoice/`,{invoice_number:s,vat:b,treatment_type:E,material_type:r})}saveInvoice(s,b,E,r,$,k,W,H,K,G){const C=new FormData;return C.append("vat",s),C.append("id_business",b),C.append("invoice_number",E),C.append("id_detail",r),C.append("date_pr",$),C.append("value",k),C.append("valued_total",W),C.append("treatment",H),C.append("id_material",K),C.append("file",G,G.name),this.http.post(`${this.url}/invoice/`,C)}addEstablishment(s,b,E,r,$,k,W){return this.http.post(`${this.url}/add/`,{name:s,name_region:b,v_unica:E,id_region:r,id_comuna:$,address:k,id_business:W})}deleteEstablishment(s){return this.http.delete(`${this.url}/delete/${s}`)}getEstablishment(s){return this.http.get(`${this.url}/${s}`)}getEstablishmentByID(s){return this.http.get(`${this.url}/get/${s}`)}getIdByEstablishment(s,b,E,r){return this.http.get(`${this.url}/getIdByEstablishment/${s}/${b}/${E}/${r}`)}getDeclarationEstablishment(){return this.http.get(`${this.url}/declaration/`)}getDeclarationEstablishmentByIdGestor(s){const b={headers:new U.WM({"Content-Type":"application/json"})};return this.http.post(`${this.url}/declarationByIdGestor/`,{idGestors:s},b)}getAllDeclarationEstablishments(){return this.http.get(`${this.url}/alldeclaration/`)}}return v.\u0275fac=function(s){return new(s||v)(D.LFG(U.eN))},v.\u0275prov=D.Yz7({token:v,factory:v.\u0275fac,providedIn:"root"}),v})()},3813:(de,w,p)=>{p.d(w,{b:()=>e});var S=p(2340),U=p(529),D=p(8256);let e=(()=>{class v{constructor(s){this.http=s,this.url=`${S.N.API_V1_URL}/manager`}getAllManager(){return this.http.get(`${this.url}/all/`)}addManager(s,b,E,r){return this.http.post(`${this.url}/add/`,{type_material:s,region:b,id_business:E,id_region:r})}deleteManager(s){return this.http.delete(`${this.url}/delete/${s}`)}getManager(s){return this.http.get(`${this.url}/${s}`)}getAllMaterials(){return this.http.get(`${this.url}/allMaterials/`)}getAllTreatments(){return this.http.get(`${this.url}/allTreatments/`)}getAllRegions(){return this.http.get(`${this.url}/regiones/`)}getRegionFromID(s){return this.http.get(`${this.url}/regiones/${s}/`)}getAllCommunes(){return this.http.get(`${this.url}/comunas/`)}getCommunesFormatted(){return this.http.get(`${this.url}/communesFormatted/`)}getAllSubmaterial(){return this.http.get(`${this.url}/submaterial/`)}getAllSubmaterialFormatted(){return this.http.get(`${this.url}/submaterialFormatted/`)}getManagersByMaterials(s,b){const E=s.join(",");return this.http.get(`${this.url}/materials/${E}/region/${b}`)}downloadExcelTemplateInvoice(){let s=new U.WM;return s=s.set("Accept","application/vnd.ms-excel"),this.http.get(`${this.url}/excel`,{headers:s,responseType:"blob"})}}return v.\u0275fac=function(s){return new(s||v)(D.LFG(U.eN))},v.\u0275prov=D.Yz7({token:v,factory:v.\u0275fac,providedIn:"root"}),v})()},3744:(de,w,p)=>{p.r(w),p.d(w,{ManagerStatementModule:()=>ft});var S=p(6895),U=p(5792),D=p(4135),e=p(8256);let v=(()=>{class a{constructor(){}ngOnInit(){}}return a.\u0275fac=function(o){return new(o||a)},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-home"]],decls:22,vars:0,consts:[["id","content"],["aria-label","breadcrumb",1,"breadcrumbs","d-none","d-lg-block"],[1,"breadcrumb"],["aria-current","page",1,"breadcrumb-item"],["aria-hidden","true",1,"fa","fa-home"],[1,"inicio"],[1,"box","box-inicio"],[1,"row"],[1,"col-12","col-md-8"],[1,"h1"],[2,"visibility","hidden"]],template:function(o,t){1&o&&(e.TgZ(0,"div",0)(1,"nav",1)(2,"ol",2)(3,"li",3),e._UZ(4,"i",4),e._uU(5," Inicio"),e.qZA()()(),e.TgZ(6,"section",5)(7,"h1"),e._uU(8,"Inicio"),e.qZA(),e.TgZ(9,"div",6)(10,"div",7)(11,"div",8)(12,"h2",9),e._uU(13,"Bienvenido/a a M\xf3dulo de Gestores"),e.qZA(),e.TgZ(14,"p",10),e._uU(15,"Como parte de las obligaciones que establece la Ley REP, los Productores deben informar la cantidad de EyE no domiciliarios (POM) puestos en el mercado el a\xf1o anterior."),e.qZA(),e.TgZ(16,"p",10),e._uU(17,"ProREP pone a disposici\xf3n de sus socios la plataforma de declaraci\xf3n que dar\xe1 cumplimiento a la obligaci\xf3n de informar sus EyE."),e.qZA(),e.TgZ(18,"p",10),e._uU(19,"La informaci\xf3n deber\xe1 subirse en los meses de enero y febrero."),e.qZA(),e.TgZ(20,"p",10),e._uU(21,"En caso de tener dudas con respecto a su declaraci\xf3n puede ver los tutoriales y preguntas frecuentes."),e.qZA()()()()()())}}),a})();var N=p(5861),s=p(433),b=p(3224),E=p(5226),r=p.n(E),$=p(371),k=p(9821),W=p(8195);function H(a,l){if(1&a&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&a){const o=l.$implicit;e.s9C("value",o),e.xp6(1),e.Oqu(o)}}function K(a,l){if(1&a&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&a){const o=l.$implicit;e.s9C("value",o),e.xp6(1),e.Oqu(o)}}function G(a,l){if(1&a&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&a){const o=l.$implicit;e.s9C("value",o),e.xp6(1),e.Oqu(o)}}function C(a,l){if(1&a&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&a){const o=l.$implicit;e.s9C("value",o),e.xp6(1),e.Oqu(o)}}function Se(a,l){if(1&a&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&a){const o=l.$implicit,t=e.oxw();e.Q6J("value",o),e.xp6(1),e.Oqu(t.getStateText(o))}}function Ee(a,l){1&a&&(e.ynx(0),e.TgZ(1,"th"),e._uU(2,"Aprobar"),e.qZA(),e.BQk())}function Ce(a,l){1&a&&(e.TgZ(0,"span"),e._uU(1,"Por aprobar"),e.qZA())}function Fe(a,l){1&a&&(e.TgZ(0,"span"),e._uU(1,"Aprobado"),e.qZA())}const xe=function(a){return{"no-pointer":a}};function qe(a,l){if(1&a){const o=e.EpF();e.ynx(0),e.TgZ(1,"td")(2,"a",67),e.NdJ("click",function(){e.CHM(o);const n=e.oxw(),i=n.index,c=n.$implicit,m=e.oxw();return m.handleClick(i,c.STATE_GESTOR),e.KtG(m.selectedDeclarationsCount=0)}),e._UZ(3,"i",68),e.qZA()(),e.BQk()}if(2&a){const o=e.oxw().$implicit;e.xp6(2),e.Q6J("ngClass",e.VKq(3,xe,0!==o.STATE_GESTOR)),e.uIk("data-bs-target",0==o.STATE_GESTOR?"#infoModal":null),e.xp6(1),e.Q6J("ngClass",0==o.STATE_GESTOR?"color-verde-opaco":"color-verde")}}function Ne(a,l){if(1&a){const o=e.EpF();e.TgZ(0,"tr")(1,"td")(2,"section",66)(3,"input",27),e.NdJ("ngModelChange",function(n){const c=e.CHM(o).$implicit;return e.KtG(c.isChecked=n)})("change",function(){e.CHM(o);const n=e.oxw();return e.KtG(n.updateCheckboxSelection())}),e.qZA()()(),e.TgZ(4,"td"),e._uU(5),e.qZA(),e.TgZ(6,"td"),e._uU(7),e.qZA(),e.TgZ(8,"td"),e._uU(9),e.qZA(),e.TgZ(10,"td"),e._uU(11),e.qZA(),e.TgZ(12,"td"),e._uU(13),e.qZA(),e.TgZ(14,"td"),e._uU(15),e.ALo(16,"date"),e.qZA(),e.TgZ(17,"td"),e.YNc(18,Ce,2,0,"span",28),e.YNc(19,Fe,2,0,"span",28),e.qZA(),e.TgZ(20,"td"),e._uU(21),e.qZA(),e.TgZ(22,"td"),e._uU(23),e.qZA(),e.YNc(24,qe,4,5,"ng-container",28),e.qZA()}if(2&a){const o=l.$implicit,t=e.oxw();e.xp6(3),e.Q6J("disabled",0!=o.STATE_GESTOR)("ngModel",o.isChecked),e.xp6(2),e.Oqu(o.NAME_BUSINESS),e.xp6(2),e.Oqu(o.NAME_ESTABLISHMENT_REGION),e.xp6(2),e.Oqu(o.TipoTratamiento),e.xp6(2),e.Oqu(o.PRECEDENCE),e.xp6(2),e.Oqu(o.TYPE_RESIDUE),e.xp6(2),e.Oqu(e.xi3(16,13,o.FechaRetiro,"dd-MM-yyyy")),e.xp6(3),e.Q6J("ngIf",0==o.STATE_GESTOR),e.xp6(1),e.Q6J("ngIf",0!=o.STATE_GESTOR),e.xp6(2),e.Oqu(t.replaceDot(o.VALUE)),e.xp6(2),e.Oqu(t.formatValue(o.VALUE_DECLARATE)),e.xp6(1),e.Q6J("ngIf",!t.anyCheckboxSelected)}}const Ue=function(a,l){return{"btn-info":a,"btn-primary":l}};function Ie(a,l){if(1&a){const o=e.EpF();e.TgZ(0,"li")(1,"button",69),e.NdJ("click",function(){const i=e.CHM(o).$implicit,c=e.oxw();return e.KtG(c.pagTo(i))}),e._uU(2),e.qZA()()}if(2&a){const o=l.$implicit,t=e.oxw();e.xp6(1),e.Q6J("ngClass",e.WLB(2,Ue,t.pos===o+1,t.pos!==o+1)),e.xp6(1),e.Oqu(o+1)}}function ye(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un n\xfamero de factura."),e.qZA())}function Me(a,l){if(1&a&&(e.TgZ(0,"div",70),e.YNc(1,ye,2,0,"p",28),e.qZA()),2&a){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.invoiceNumber.errors.required)}}function De(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"El rut de la empresa es requerido."),e.qZA())}function Oe(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"El formato del RUT es inv\xe1lido (Sin puntos y con gui\xf3n)."),e.qZA())}function Re(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"El digito verificador es incorrecto. "),e.qZA())}function Pe(a,l){if(1&a&&(e.TgZ(0,"div",51),e.YNc(1,De,2,0,"p",28),e.YNc(2,Oe,2,0,"p",28),e.YNc(3,Re,2,0,"p",28),e.qZA()),2&a){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.rut.errors.required),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.rut.errors.pattern),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.rut.errors.rut)}}function we(a,l){if(1&a&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&a){const o=l.$implicit;e.s9C("value",o.ID),e.xp6(1),e.Oqu(o.NAME)}}function ke(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"Rut no se encuentra registrado en el sistema. "),e.qZA())}function We(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"El rut de la empresa es requerido."),e.qZA())}function Be(a,l){if(1&a&&(e.TgZ(0,"div",51),e.YNc(1,We,2,0,"p",28),e.qZA()),2&a){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.treatmentType.errors.required)}}function $e(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"El rut de la empresa es requerido."),e.qZA())}function Je(a,l){if(1&a&&(e.TgZ(0,"div",51),e.YNc(1,$e,2,0,"p",28),e.qZA()),2&a){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.material.errors.required)}}function Le(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar una fecha. "),e.qZA())}function Ye(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"La fecha no puede ser futura."),e.qZA())}function Ve(a,l){if(1&a&&(e.TgZ(0,"div",70),e.YNc(1,Le,2,0,"p",28),e.YNc(2,Ye,2,0,"p",28),e.qZA()),2&a){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.entryDate.errors.required),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.entryDate.errors.futureDate)}}function Qe(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un peso total."),e.qZA())}function Ge(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un n\xfamero v\xe1lido (con coma)."),e.qZA())}function je(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"El valor debe ser mayor que cero."),e.qZA())}function ze(a,l){if(1&a&&(e.TgZ(0,"div",70),e.YNc(1,Qe,2,0,"p",28),e.YNc(2,Ge,2,0,"p",28),e.YNc(3,je,2,0,"p",28),e.qZA()),2&a){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.totalWeight.errors.required),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.totalWeight.errors.pattern),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.totalWeight.errors.minStringValue)}}function He(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un peso valorizado."),e.qZA())}function Ke(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un n\xfamero v\xe1lido (Con coma)."),e.qZA())}function Xe(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"El valor debe ser mayor que cero."),e.qZA())}function et(a,l){if(1&a&&(e.TgZ(0,"div",70),e.YNc(1,He,2,0,"p",28),e.YNc(2,Ke,2,0,"p",28),e.YNc(3,Xe,2,0,"p",28),e.qZA()),2&a){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.valuedWeight.errors.required),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.valuedWeight.errors.pattern),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.valuedWeight.errors.minStringValue)}}function tt(a,l){1&a&&(e.TgZ(0,"div",51)(1,"p"),e._uU(2,"El peso remanente no puede ser menor que cero."),e.qZA()())}function ot(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"El formato del archivo debe ser PDF, JPEG o JPG."),e.qZA())}function nt(a,l){1&a&&(e.TgZ(0,"p"),e._uU(1,"El tama\xf1o del archivo no debe superar 1 MB."),e.qZA())}function at(a,l){if(1&a&&(e.TgZ(0,"div",51),e.YNc(1,ot,2,0,"p",28),e.YNc(2,nt,2,0,"p",28),e.qZA()),2&a){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.attachment.errors.invalidFileType),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.attachment.errors.invalidFileSize)}}let it=(()=>{class a{constructor(o,t,n,i,c){this.productorService=o,this.establishmentService=t,this.businessService=n,this.fb=i,this.cdr=c,this.disableWeightFields=!0,this.dbStatements=[],this.db=[],this.pos=1,this.business_name=[],this.establishment_name=[],this.material_name=[],this.treatment_name=[],this.years=[],this.state=[],this.cant=0,this.filteredStatements=[],this.selectedBusiness="-1",this.selectedMaterial="-1",this.selectedYear="-1",this.selectedTreatment="-1",this.selectedState="-1",this.selectAllChecked=!1,this.autoFilter=!0,this.isRemainingWeightNegative=!1,this.anyCheckboxSelected=!1,this.index=0,this.userForm=this.fb.group({invoiceNumber:["",[s.kI.required]],rut:["",[s.kI.required,s.kI.pattern("^[0-9]{1,2}[0-9]{3}[0-9]{3}-[0-9Kk]{1}$"),this.verifyRut]],reciclador:["0",[s.kI.required]],treatmentType:["",[s.kI.required]],material:["",[s.kI.required]],entryDate:["",[s.kI.required,this.pastDateValidator()]],totalWeight:["",[s.kI.required,this.minStringValue(0),s.kI.pattern(/^[0-9]+(,[0-9]+)?$/)]],declarateWeight:[""],valuedWeight:["",[s.kI.required,this.minStringValue(0),s.kI.pattern(/^[0-9]+(,[0-9]+)?$/)]],remainingWeight:[""],asoc:[""],declarated:[""],attachment:[null,[s.kI.required,this.fileTypeValidator,this.fileSizeValidator]]}),this.dbBusiness=[],this.selectedDeclarationsCount=0,this.selectedWeight=0,this.isAnyCheckboxSelected=!1,this.businessNoFound=!1}ngOnInit(){this.userData=JSON.parse(sessionStorage.getItem("user")),this.loadStatements().then(()=>{this.filter(),this.pagTo(this.pos-1)}),this.userForm.controls.valuedWeight.disable(),this.userForm.controls.totalWeight.disable(),this.userForm.controls.reciclador.disable()}loadStatements(){return new Promise(o=>{const t=JSON.parse(sessionStorage.getItem("user")).ID_BUSINESS;r().fire({title:"Cargando Datos",text:"Se est\xe1n recuperando datos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1}),r().showLoading(),this.establishmentService.getDeclarationEstablishmentByIdGestor(t).subscribe(n=>{n.status&&(n.data=n.data.filter(i=>null!=i.TipoTratamiento),n.data=n.data.sort((i,c)=>{const m=new Date(c.FechaRetiro).getTime()-new Date(i.FechaRetiro).getTime();return 0===m?c.ID_DETAIL-i.ID_DETAIL:m}),n.data.forEach(i=>{i.isChecked=!1,-1==this.business_name.indexOf(i.NAME_BUSINESS)&&this.business_name.push(i.NAME_BUSINESS),-1==this.establishment_name.indexOf(i.NAME_ESTABLISHMENT_REGION)&&this.establishment_name.push(i.NAME_ESTABLISHMENT_REGION),-1==this.years.indexOf(i.FechaRetiroTipeada)&&this.years.push(i.FechaRetiroTipeada),-1==this.material_name.indexOf(i.PRECEDENCE)&&this.material_name.push(i.PRECEDENCE),-1===this.treatment_name.indexOf(i.TipoTratamiento)&&this.treatment_name.push(i.TipoTratamiento),-1==this.state.indexOf(i.STATE_GESTOR)&&this.state.push(i.STATE_GESTOR)}),this.years.sort((i,c)=>c-i),this.dbStatements=n.data,this.cant=Math.ceil(this.dbStatements.length/10),this.db=this.dbStatements.slice(10*(this.pos-1),10*this.pos).sort((i,c)=>{const m=new Date(c.FechaRetiro).getTime()-new Date(i.FechaRetiro).getTime();return 0===m?c.ID_DETAIL-i.ID_DETAIL:m}),r().close()),o()})})}openApprovalModal(){const o=this.db.filter(t=>t.isChecked&&0==t.STATE_GESTOR);o.length>0?(this.userForm.patchValue({declarated:this.selectedWeight,treatmentType:o[0].TipoTratamiento,material:o[0].PRECEDENCE}),document.getElementById("openModalButton")?.click()):console.log("error")}filter(o=!1){o&&!this.autoFilter||(this.filteredStatements=this.dbStatements.filter(t=>!("-1"!==this.selectedBusiness&&t.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedMaterial&&t.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedTreatment&&t.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedYear&&t.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&parseInt(t.STATE_GESTOR)!==parseInt(this.selectedState))),this.db=this.filteredStatements.slice(0,10).sort((t,n)=>{const i=new Date(n.FechaRetiro).getTime()-new Date(t.FechaRetiro).getTime();return 0===i?n.ID_DETAIL-t.ID_DETAIL:i}),this.cant=Math.ceil(this.filteredStatements.length/10),this.selectedDeclarationsCount=0,this.selectedWeight=0,this.selectAllChecked=!1,this.filteredStatements.forEach(t=>{0==t.STATE_GESTOR&&(t.isChecked=!1)}),this.anyCheckboxSelected=this.filteredStatements.some(t=>t.isChecked&&0==t.STATE_GESTOR),this.cdr.detectChanges())}filter_two(o=!1){o&&!this.autoFilter||(this.filteredStatements=this.dbStatements.filter(t=>!("-1"!==this.selectedBusiness&&t.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedMaterial&&t.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedTreatment&&t.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedYear&&t.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&parseInt(t.STATE_GESTOR)!==parseInt(this.selectedState))),this.db=this.filteredStatements.slice(0,10).sort((t,n)=>{const i=new Date(n.FechaRetiro).getTime()-new Date(t.FechaRetiro).getTime();return 0===i?n.ID_DETAIL-t.ID_DETAIL:i}),this.cant=Math.ceil(this.filteredStatements.length/10))}updateFilters(){this.business_name=this.dbStatements.filter(o=>!("-1"!==this.selectedTreatment&&o.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedMaterial&&o.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedYear&&o.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&parseInt(o.STATE_GESTOR)!==parseInt(this.selectedState)&&void 0!==o.STATE_GESTOR)).map(o=>o.NAME_BUSINESS).filter((o,t,n)=>n.indexOf(o)===t),this.treatment_name=this.dbStatements.filter(o=>!("-1"!==this.selectedBusiness&&o.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedMaterial&&o.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedYear&&o.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&parseInt(o.STATE_GESTOR)!==parseInt(this.selectedState)&&void 0!==o.STATE_GESTOR)).map(o=>o.TipoTratamiento).filter((o,t,n)=>n.indexOf(o)===t),this.material_name=this.dbStatements.filter(o=>!("-1"!==this.selectedBusiness&&o.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedTreatment&&o.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedYear&&o.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&parseInt(o.STATE_GESTOR)!==parseInt(this.selectedState)&&void 0!==o.STATE_GESTOR)).map(o=>o.PRECEDENCE).filter((o,t,n)=>n.indexOf(o)===t),this.years=this.dbStatements.filter(o=>!("-1"!==this.selectedBusiness&&o.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedTreatment&&o.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedMaterial&&o.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedState&&parseInt(o.STATE_GESTOR)!==parseInt(this.selectedState)&&void 0!==o.STATE_GESTOR)).map(o=>o.FechaRetiroTipeada).filter((o,t,n)=>n.indexOf(o)===t).sort((o,t)=>t-o),this.state=this.dbStatements.filter(o=>!("-1"!==this.selectedBusiness&&o.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedTreatment&&o.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedMaterial&&o.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedYear&&o.FechaRetiroTipeada!==this.selectedYear)).map(o=>parseInt(o.STATE_GESTOR)).filter((o,t,n)=>n.indexOf(o)===t)}reset(){this.loadStatements().then(()=>{this.filter(),this.pagTo(this.pos-1)}),this.userForm.reset({reciclador:"0"})}reset_nocheck(){this.userForm.reset({reciclador:"0"})}pagTo(o){this.pos=o+1,this.db=this.filteredStatements.slice(10*o,10*(o+1)).sort((t,n)=>{const i=new Date(n.FechaRetiro).getTime()-new Date(t.FechaRetiro).getTime();return 0===i?n.ID_DETAIL-t.ID_DETAIL:i})}next(){this.pos>=this.cant||(this.pos++,this.db=this.filteredStatements.slice(10*(this.pos-1),10*this.pos).sort((o,t)=>{const n=new Date(t.FechaRetiro).getTime()-new Date(o.FechaRetiro).getTime();return 0===n?t.ID_DETAIL-o.ID_DETAIL:n}))}previus(){this.pos-1<=0||this.pos>=this.cant+1||(this.pos=this.pos-1,this.db=this.filteredStatements.slice(10*(this.pos-1),10*this.pos).sort((o,t)=>{const n=new Date(t.FechaRetiro).getTime()-new Date(o.FechaRetiro).getTime();return 0===n?t.ID_DETAIL-o.ID_DETAIL:n}))}setArrayFromNumber(){return new Array(this.cant)}visiblePageNumbers(){const o=this.setArrayFromNumber().length,t=[];if(o<=15)for(let n=0;n<o;n++)t.push(n);else{let n=Math.max(0,this.pos-Math.floor(7.5)),i=Math.min(o-1,n+14);i-n+1<15&&(i=o-1,n=Math.max(0,i-14));for(let c=n;c<=i;c++)t.push(c)}return t}getStateText(o){return 0===o?"Por aprobar":"Aprobado"}handleClick(o,t){this.dbBusiness=[],0===t&&(this.onMaterialTreatmentChange(o),this.index=o)}fileTypeValidator(o){const t=o.value;return t&&!["application/pdf","image/jpeg"].includes(t.type)?{invalidFileType:!0}:null}fileSizeValidator(o){const t=o.value;return t&&t.size>1048576?{invalidFileSize:!0}:null}onFileSelected(o){const t=o.target;if(t&&t.files&&t.files.length>0){const n=t.files[0];this.fileName=n.name,this.fileBuffer=n,this.selectedFile=t.files[0];const i=["pdf","jpeg","jpg"],c=this.selectedFile.name.split(".").pop()?.toLowerCase()||"";i.includes(c)?n.size>1048576?(this.userForm.controls.attachment.setErrors({invalidFileSize:!0}),this.userForm.controls.attachment.markAsTouched()):(this.userForm.controls.attachment.setErrors(null),this.userForm.controls.attachment.markAsTouched()):(this.userForm.controls.attachment.setErrors({invalidFileType:!0}),this.userForm.controls.attachment.markAsTouched())}else this.selectedFile=null}saveInvoice(o){var t=this;return(0,N.Z)(function*(){if(t.selectedFile){let{rut:n,invoiceNumber:i,entryDate:c,valuedWeight:m,reciclador:Z}=t.userForm.value;const _=t.userForm.controls.totalWeight.value,x=t.filteredStatements.filter(T=>T.isChecked&&0==T.STATE_GESTOR);if(x.length>0)try{m=(parseFloat(m.replace(",","."))/x.length).toFixed(2),r().fire({title:"Cargando Datos",text:"Se est\xe1n recuperando datos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1});for(let T=0;T<x.length;T++){const I=x[T].TREATMENT_TYPE_NUMBER,F=x[T].PRECEDENCE_NUMBER,A=x[T].ID_DETAIL;if((yield t.establishmentService.saveInvoice(n,Z,i,A,c,m,_.replace(",","."),I,F,t.selectedFile).toPromise()).status){const u=t.db.find(d=>d.ID_DETAIL===A);u&&(u.STATE_GESTOR=1,u.VALUE_DECLARATE=m.replace(".",",")),t.cdr.detectChanges()}}r().close(),setTimeout((0,N.Z)(function*(){yield r().fire({title:"Las facturas fueron guardadas exitosamente",text:"",icon:"success",showConfirmButton:!0})}),1500)}catch(T){console.error("Error:",T)}else{const T=t.db[o].TREATMENT_TYPE_NUMBER,I=t.db[o].PRECEDENCE_NUMBER,F=t.db[o].ID_DETAIL;try{if((yield t.establishmentService.saveInvoice(n,Z,i,F,c,m.replace(",","."),_.replace(",","."),T,I,t.selectedFile).toPromise()).status){const y=t.db.find(u=>u.ID_DETAIL===F);y&&(y.STATE_GESTOR=1,y.VALUE_DECLARATE=parseFloat(m.replace(",",".")).toFixed(2).replace(".",",")),t.cdr.detectChanges(),r().close(),setTimeout((0,N.Z)(function*(){yield r().fire({title:"La factura fue guardada exitosamente",text:"",icon:"success",showConfirmButton:!0})}),1500)}}catch(A){console.error("Error:",A)}}}else console.error("No file selected")})()}onChangeVAT(o){this.dbBusiness=[],this.businessService.getBusinessByVAT(o.value).subscribe(t=>{this.dbBusiness=t.status||[],this.userForm.controls.reciclador.enable(),this.businessNoFound=!1,0==this.dbBusiness.length&&(this.businessNoFound=!0,this.userForm.controls.reciclador.disable(),this.userForm.controls.reciclador.setValue("0"))})}formatNumber(o){return null==o?"":Number.isInteger(o)?o.toString():o.toLocaleString("es")}onRUTChange(o){var t=this;return(0,N.Z)(function*(){const n=t.userForm.controls.rut.value,i=t.userForm.controls.invoiceNumber.value,c=t.db[o].TREATMENT_TYPE_NUMBER,m=t.db[o].PRECEDENCE_NUMBER;if(n)try{const _=yield t.establishmentService.getInovice(i,n,c,m).toPromise();_.status?(t.userForm.controls.totalWeight.setValue(t.formatNumber(_.data[0]?.invoice_value)),t.userForm.controls.declarateWeight.setValue(t.formatNumber(_.data[0].value_declarated)),t.userForm.controls.asoc.setValue(0!=t.selectedDeclarationsCount?_.data[0].num_asoc+t.selectedDeclarationsCount:_.data[0].num_asoc+1),parseInt(t.userForm.controls.asoc.value||"0")>1&&0==t.selectedDeclarationsCount?i?t.userForm.controls.valuedWeight.enable():t.userForm.controls.valuedWeight.disable():i?(t.userForm.controls.valuedWeight.enable(),t.userForm.controls.totalWeight.enable()):(t.userForm.controls.valuedWeight.disable(),t.userForm.controls.totalWeight.disable())):(r().fire({icon:"error",text:_.msg}),t.userForm.controls.totalWeight.setValue(""),t.userForm.controls.declarateWeight.setValue(""),t.userForm.controls.asoc.setValue(""),t.userForm.controls.remainingWeight.setValue(""),t.userForm.controls.valuedWeight.disable(),t.userForm.controls.totalWeight.disable())}catch{t.userForm.controls.totalWeight.setValue(""),t.userForm.controls.declarateWeight.setValue(""),t.userForm.controls.asoc.setValue(""),t.userForm.controls.remainingWeight.setValue(""),t.userForm.controls.valuedWeight.disable(),t.userForm.controls.totalWeight.disable()}else t.userForm.controls.totalWeight.setValue(""),t.userForm.controls.declarateWeight.setValue(""),t.userForm.controls.asoc.setValue(""),t.userForm.controls.remainingWeight.setValue(""),t.userForm.controls.valuedWeight.disable(),t.userForm.controls.totalWeight.disable();t.userForm.controls.valuedWeight.updateValueAndValidity(),t.userForm.controls.totalWeight.updateValueAndValidity()})()}onMaterialTreatmentChange(o){var t=this;return(0,N.Z)(function*(){t.userForm.controls.treatmentType.setValue(t.db[o].TipoTratamiento),t.userForm.controls.material.setValue(t.db[o].PRECEDENCE),t.userForm.controls.declarated.setValue(t.db[o].VALUE?.toString().replace(".",","))})()}verifyRut(o){return(0,b.validate)(o.value)?null:{rut:!0}}isTotalWeightEditable(){return!!this.userForm.controls.invoiceNumber.value&&!!this.userForm.controls.rut.value}getNumericValue(o){return o&&o.value?+o.value.toString().replace(",","."):0}calculateRemainingWeight(){const o=this.userForm.get("totalWeight"),t=this.userForm.get("valuedWeight"),n=this.userForm.get("declarateWeight"),Z=this.getNumericValue(o)-this.getNumericValue(t)-this.getNumericValue(n);return this.isRemainingWeightNegative=Z<0,Z.toFixed(2).replace(".",",")}replaceDot(o){return 2==o.toString().split(".").length?o&&parseFloat(o).toFixed(2).replace(".",","):o&&o.toString().replace(".",",")}minStringValue(o){return t=>{if(!t.value)return null;const n=parseFloat(t.value.replace(",","."));return isNaN(n)||n<=o?{minStringValue:{value:t.value}}:null}}formatValue(o){return null==o?"":o%1==0?o.toString():o.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})}pastDateValidator(){return o=>{const t=new Date(o.value),n=new Date;return n.setHours(0,0,0,0),t>n?{futureDate:{value:o.value}}:null}}updateCheckboxSelection(){const o=this.filteredStatements.filter(n=>n.isChecked&&0==n.STATE_GESTOR);this.anyCheckboxSelected=o.length>0,this.selectedDeclarationsCount=o.length;let t=o.reduce((n,i)=>n+parseFloat(i.VALUE),0);if(this.selectedWeight=t%1==0?t.toLocaleString("es-ES"):t.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2}),o.length>0){const n=o[0];this.selectedTreatment=n.TipoTratamiento,this.selectedMaterial=n.PRECEDENCE,this.selectedState="0",this.disableFilters=!0,this.updateFilters()}else this.selectedTreatment="-1",this.selectedMaterial="-1",this.selectedState="-1",this.disableFilters=!1,this.filter_two(),this.updateFilters(),this.pagTo(0);this.isAnyCheckboxSelected=o.length>0,1==o.length&&(this.filter_two(),this.updateFilters(),this.pagTo(0))}selectAllCheckboxes(o){this.filteredStatements.forEach(t=>{0==t.STATE_GESTOR&&(t.isChecked=o)}),this.db=this.filteredStatements.slice(10*(this.pos-1),10*this.pos),this.updateCheckboxSelection()}onSelectAllCheckboxChange(o){const t=o.target;this.filteredStatements.forEach(c=>{0==c.STATE_GESTOR&&(c.isChecked=t.checked)}),this.db=this.filteredStatements.slice(10*(this.pos-1),10*this.pos);const n=this.filteredStatements.filter(c=>c.isChecked&&0==c.STATE_GESTOR);this.anyCheckboxSelected=this.filteredStatements.some(c=>c.isChecked&&0==c.STATE_GESTOR),this.cdr.detectChanges(),this.selectedDeclarationsCount=n.length,this.disableFilters=0!=this.selectedDeclarationsCount;let i=n.reduce((c,m)=>c+parseFloat(m.VALUE),0);this.selectedWeight=i%1==0?i.toLocaleString("es-ES"):i.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})}}return a.\u0275fac=function(o){return new(o||a)(e.Y36($.u),e.Y36(k.d),e.Y36(W.m),e.Y36(s.qu),e.Y36(e.sBO))},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-statements"]],decls:211,vars:37,consts:[[1,"container","mt-4"],["aria-label","breadcrumb",1,"breadcrumbs","d-none","d-lg-block"],[1,"breadcrumb"],[1,"breadcrumb-item"],["href","#"],["aria-hidden","true",1,"fa","fa-home"],["aria-current","page",1,"breadcrumb-item","active"],[1,"declaracion"],[1,"box","box-form","mb-4"],[1,"row","align-items-end"],[1,"col-12","col-xl-2","mb-3","mb-xl-0"],[1,"form-label"],[1,"input-group"],["id","f_name",1,"form-select",3,"ngModel","ngModelChange","change"],["value","-1","selected",""],[3,"value",4,"ngFor","ngForOf"],["id","f_establishment",1,"form-select",3,"ngModel","disabled","ngModelChange","change"],["id","f_material",1,"form-select",3,"ngModel","disabled","ngModelChange","change"],["id","f_year",1,"form-select",3,"ngModel","ngModelChange","change"],["id","f_state",1,"form-select",3,"ngModel","disabled","ngModelChange","change"],[1,"btn","btn-primary","w-100",3,"click"],[1,"col-12","col-xl-3","mb-3","mb-xl-0"],["type","text","readonly","",1,"form-control",3,"ngModel","ngModelChange"],[1,"btn","btn-primary","w-100",3,"disabled","click"],[1,"table-responsive"],[1,"table","table-even","table-section","table-borderless","table-radius"],[1,"vertical-middle"],["type","checkbox",3,"disabled","ngModel","ngModelChange","change"],[4,"ngIf"],[4,"ngFor","ngForOf"],["aria-label","Navegaci\xf3n resultados"],[1,"pagination"],[1,"btn","btn-primary",3,"click"],["id","infoModal","tabindex","-1","aria-labelledby","exampleModalLabel","aria-hidden","true",1,"modal","fade",3,"hidden.bs.modal"],[1,"modal-dialog","modal-lg"],[1,"modal-content"],[1,"modal-header"],["id","exampleModalLabel",1,"modal-title","fs-5"],["type","button","data-bs-dismiss","modal","aria-label","Close",1,"btn-close"],[1,"modal-body"],[3,"formGroup"],["miFormulario","ngForm"],[1,"row","mb-3"],[1,"col-sm-4","col-form-label"],[1,"col-sm-8"],["type","text","placeholder","1234","formControlName","invoiceNumber",1,"form-control",3,"input"],["class","text-danger",4,"ngIf"],["type","text","placeholder","1-9","formControlName","rut",1,"form-control",3,"readonly","change"],["class","text-danger pl-0",4,"ngIf"],["formControlName","reciclador",1,"form-select",3,"disabled","change"],["value","0"],[1,"text-danger","pl-0"],["type","text","placeholder","Tipo tratamiento","formControlName","treatmentType","readonly","",1,"form-control"],["type","text","placeholder","Tipo material","formControlName","material","readonly","",1,"form-control"],["type","date","placeholder","10/4/2023","formControlName","entryDate",1,"form-control"],["type","text","formControlName","totalWeight",1,"form-control"],["type","text","formControlName","declarated","readonly","",1,"form-control"],["type","text","formControlName","valuedWeight",1,"form-control"],["type","text","formControlName","remainingWeight","readonly","",1,"form-control",3,"value"],["type","text","formControlName","asoc","readonly","",1,"form-control"],["type","file","formControlName","attachment","id","inp_attachment","accept","application/pdf, image/jpeg","required","",1,"form-control",3,"change"],[1,"modal-footer"],["type","button","data-bs-dismiss","modal",1,"btn","btn-secondary",3,"click"],["type","button","data-bs-dismiss","modal",1,"btn","btn-primary",3,"disabled","click"],["id","openModalButton","data-bs-toggle","modal","data-bs-target","#infoModal",2,"display","none"],[3,"value"],[1,"example-section"],["data-bs-toggle","modal",1,"custom-cursor",3,"ngClass","click"],["aria-hidden","true",1,"fa","fa-check","fa-lg","fa-fw",3,"ngClass"],[1,"border","btn","btn-sm",3,"ngClass","click"],[1,"text-danger"]],template:function(o,t){1&o&&(e.TgZ(0,"div",0)(1,"nav",1)(2,"ol",2)(3,"li",3)(4,"a",4),e._UZ(5,"i",5),e._uU(6," Inicio"),e.qZA()(),e.TgZ(7,"li",6),e._uU(8,"Consulta de Declaraci\xf3n"),e.qZA()()(),e.TgZ(9,"section",7)(10,"h1"),e._uU(11,"Consulta de Declaraci\xf3n"),e.qZA(),e.TgZ(12,"div",8)(13,"div",9)(14,"div",10)(15,"label",11),e._uU(16,"Empresa CI:"),e.qZA(),e.TgZ(17,"div",12)(18,"select",13),e.NdJ("ngModelChange",function(i){return t.selectedBusiness=i})("change",function(){return t.updateFilters()}),e.TgZ(19,"option",14),e._uU(20,"Todos"),e.qZA(),e.YNc(21,H,2,2,"option",15),e.qZA()()(),e.TgZ(22,"div",10)(23,"label",11),e._uU(24,"Tipo de tratamiento:"),e.qZA(),e.TgZ(25,"div",12)(26,"select",16),e.NdJ("ngModelChange",function(i){return t.selectedTreatment=i})("change",function(){return t.updateFilters()}),e.TgZ(27,"option",14),e._uU(28,"Todos"),e.qZA(),e.YNc(29,K,2,2,"option",15),e.qZA()()(),e.TgZ(30,"div",10)(31,"label",11),e._uU(32,"Material:"),e.qZA(),e.TgZ(33,"div",12)(34,"select",17),e.NdJ("ngModelChange",function(i){return t.selectedMaterial=i})("change",function(){return t.updateFilters()}),e.TgZ(35,"option",14),e._uU(36,"Todos"),e.qZA(),e.YNc(37,G,2,2,"option",15),e.qZA()()(),e.TgZ(38,"div",10)(39,"label",11),e._uU(40,"Fecha de retiro:"),e.qZA(),e.TgZ(41,"div",12)(42,"select",18),e.NdJ("ngModelChange",function(i){return t.selectedYear=i})("change",function(){return t.updateFilters()}),e.TgZ(43,"option",14),e._uU(44,"Todos"),e.qZA(),e.YNc(45,C,2,2,"option",15),e.qZA()()(),e.TgZ(46,"div",10)(47,"label",11),e._uU(48,"Estado:"),e.qZA(),e.TgZ(49,"div",12)(50,"select",19),e.NdJ("ngModelChange",function(i){return t.selectedState=i})("change",function(){return t.updateFilters()}),e.TgZ(51,"option",14),e._uU(52,"Todos"),e.qZA(),e.YNc(53,Se,2,2,"option",15),e.qZA()()(),e.TgZ(54,"div",10)(55,"label",11),e._uU(56,"\xa0"),e.qZA(),e.TgZ(57,"div",12)(58,"button",20),e.NdJ("click",function(){return t.autoFilter=!1,t.filter(),t.pagTo(0),t.disableFilters=!1}),e._uU(59,"Mostrar"),e.qZA()()(),e.TgZ(60,"div",21)(61,"label",11),e._uU(62,"N\xfamero de declaraciones seleccionadas:"),e.qZA(),e.TgZ(63,"div",12)(64,"input",22),e.NdJ("ngModelChange",function(i){return t.selectedDeclarationsCount=i}),e.qZA()()(),e.TgZ(65,"div",21),e._UZ(66,"p"),e.TgZ(67,"label",11),e._uU(68,"Peso total declarado seleccionado (Kg):"),e.qZA(),e.TgZ(69,"div",12)(70,"input",22),e.NdJ("ngModelChange",function(i){return t.selectedWeight=i}),e.qZA()()(),e.TgZ(71,"div",10),e._UZ(72,"p"),e.TgZ(73,"label",11),e._uU(74,"\xa0"),e.qZA(),e.TgZ(75,"div",12)(76,"button",23),e.NdJ("click",function(){return t.openApprovalModal()}),e._uU(77," Aprobar Selecci\xf3n "),e.qZA()()()()(),e.TgZ(78,"div",24)(79,"table",25)(80,"thead",26)(81,"tr")(82,"th")(83,"input",27),e.NdJ("ngModelChange",function(i){return t.selectAllChecked=i})("change",function(i){return t.onSelectAllCheckboxChange(i)}),e.qZA(),e._uU(84," Seleccionar todo "),e.qZA(),e.TgZ(85,"th"),e._uU(86,"Empresa CI"),e.qZA(),e.TgZ(87,"th"),e._uU(88,"Establecimiento CI"),e.qZA(),e.TgZ(89,"th"),e._uU(90,"Tipo de tratamiento"),e.qZA(),e.TgZ(91,"th"),e._uU(92,"Material"),e.qZA(),e.TgZ(93,"th"),e._uU(94,"Subtipo"),e.qZA(),e.TgZ(95,"th"),e._uU(96,"Fecha Retiro"),e.qZA(),e.TgZ(97,"th"),e._uU(98,"Estado"),e.qZA(),e.TgZ(99,"th"),e._uU(100,"Peso Declarado"),e.qZA(),e.TgZ(101,"th"),e._uU(102,"Peso Valorizado"),e.qZA(),e.YNc(103,Ee,3,0,"ng-container",28),e.qZA()(),e.TgZ(104,"tbody"),e.YNc(105,Ne,25,16,"tr",29),e.qZA()()(),e.TgZ(106,"nav",30)(107,"ul",31)(108,"li")(109,"button",32),e.NdJ("click",function(){return t.pagTo(0)}),e._uU(110,"Primero"),e.qZA()(),e.TgZ(111,"li")(112,"button",32),e.NdJ("click",function(){return t.previus()}),e._uU(113,"Anterior"),e.qZA()(),e.YNc(114,Ie,3,5,"li",29),e.TgZ(115,"li")(116,"button",32),e.NdJ("click",function(){return t.next()}),e._uU(117,"Siguiente"),e.qZA()(),e.TgZ(118,"li")(119,"button",32),e.NdJ("click",function(){return t.pagTo(t.cant-1)}),e._uU(120,"\xdaltimo"),e.qZA()()()()()(),e.TgZ(121,"div",33),e.NdJ("hidden.bs.modal",function(){return t.reset_nocheck()}),e.TgZ(122,"div",34)(123,"div",35)(124,"div",36)(125,"h1",37),e._uU(126,"Asignar factura reciclador"),e.qZA(),e._UZ(127,"button",38),e.qZA(),e.TgZ(128,"div",39)(129,"form",40,41)(131,"div",42)(132,"label",43),e._uU(133,"N\xfam. Factura Reciclador"),e.qZA(),e.TgZ(134,"div",44)(135,"input",45),e.NdJ("input",function(){return t.onRUTChange(t.index)}),e.qZA(),e.YNc(136,Me,2,1,"div",46),e.qZA()(),e.TgZ(137,"div",42)(138,"label",43),e._uU(139,"RUT Reciclador"),e.qZA(),e.TgZ(140,"div",44)(141,"input",47),e.NdJ("change",function(i){return t.onChangeVAT(i.target)}),e.qZA(),e.YNc(142,Pe,4,3,"div",48),e.qZA()(),e.TgZ(143,"div",42)(144,"label",43),e._uU(145,"Reciclador"),e.qZA(),e.TgZ(146,"div",44)(147,"select",49),e.NdJ("change",function(){return t.onRUTChange(t.index)}),e.TgZ(148,"option",50),e._uU(149,"Seleccione Reciclador"),e.qZA(),e.YNc(150,we,2,2,"option",15),e.qZA(),e.TgZ(151,"div",51),e.YNc(152,ke,2,0,"p",28),e.qZA()()(),e.TgZ(153,"div",42)(154,"label",43),e._uU(155,"Tipo Tratamiento"),e.qZA(),e.TgZ(156,"div",44),e._UZ(157,"input",52),e.YNc(158,Be,2,1,"div",48),e.qZA()(),e.TgZ(159,"div",42)(160,"label",43),e._uU(161,"Material"),e.qZA(),e.TgZ(162,"div",44),e._UZ(163,"input",53),e.YNc(164,Je,2,1,"div",48),e.qZA()(),e.TgZ(165,"div",42)(166,"label",43),e._uU(167,"Fecha Ingreso PR"),e.qZA(),e.TgZ(168,"div",44),e._UZ(169,"input",54),e.YNc(170,Ve,3,2,"div",46),e.qZA()(),e.TgZ(171,"div",42)(172,"label",43),e._uU(173,"Peso Total Factura Reciclador"),e.qZA(),e.TgZ(174,"div",44),e._UZ(175,"input",55),e.YNc(176,ze,4,3,"div",46),e.qZA()(),e.TgZ(177,"div",42)(178,"label",43),e._uU(179,"Peso Declarado"),e.qZA(),e.TgZ(180,"div",44),e._UZ(181,"input",56),e.qZA()(),e.TgZ(182,"div",42)(183,"label",43),e._uU(184,"Peso Valorizado"),e.qZA(),e.TgZ(185,"div",44),e._UZ(186,"input",57),e.YNc(187,et,4,3,"div",46),e.qZA()(),e.TgZ(188,"div",42)(189,"label",43),e._uU(190,"Peso Remanente"),e.qZA(),e.TgZ(191,"div",44),e._UZ(192,"input",58),e.YNc(193,tt,3,0,"div",48),e.qZA()(),e.TgZ(194,"div",42)(195,"label",43),e._uU(196,"Num. Declaraciones asociadas"),e.qZA(),e.TgZ(197,"div",44),e._UZ(198,"input",59),e.qZA()(),e.TgZ(199,"div",42)(200,"label",43),e._uU(201,"Adjuntar"),e.qZA(),e.TgZ(202,"div",44)(203,"input",60),e.NdJ("change",function(i){return t.onFileSelected(i)}),e.qZA(),e.YNc(204,at,3,2,"div",48),e.qZA()()()(),e.TgZ(205,"div",61)(206,"button",62),e.NdJ("click",function(){return t.userForm.reset({reciclador:"0"})}),e._uU(207,"Volver"),e.qZA(),e.TgZ(208,"button",63),e.NdJ("click",function(){return t.saveInvoice(t.index),t.reset(),t.disableFilters=!1}),e._uU(209,"Guardar"),e.qZA()()()()(),e._UZ(210,"a",64)),2&o&&(e.xp6(18),e.Q6J("ngModel",t.selectedBusiness),e.xp6(3),e.Q6J("ngForOf",t.business_name),e.xp6(5),e.Q6J("ngModel",t.selectedTreatment)("disabled",t.disableFilters),e.xp6(3),e.Q6J("ngForOf",t.treatment_name),e.xp6(5),e.Q6J("ngModel",t.selectedMaterial)("disabled",t.disableFilters),e.xp6(3),e.Q6J("ngForOf",t.material_name),e.xp6(5),e.Q6J("ngModel",t.selectedYear),e.xp6(3),e.Q6J("ngForOf",t.years),e.xp6(5),e.Q6J("ngModel",t.selectedState)("disabled",t.disableFilters),e.xp6(3),e.Q6J("ngForOf",t.state),e.xp6(11),e.Q6J("ngModel",t.selectedDeclarationsCount),e.xp6(6),e.Q6J("ngModel",t.selectedWeight),e.xp6(6),e.Q6J("disabled",0==t.selectedDeclarationsCount&&0==t.selectedWeight),e.xp6(7),e.Q6J("disabled",!t.isAnyCheckboxSelected)("ngModel",t.selectAllChecked),e.xp6(20),e.Q6J("ngIf",!t.anyCheckboxSelected),e.xp6(2),e.Q6J("ngForOf",t.db),e.xp6(9),e.Q6J("ngForOf",t.visiblePageNumbers()),e.xp6(15),e.Q6J("formGroup",t.userForm),e.xp6(7),e.Q6J("ngIf",t.userForm.controls.invoiceNumber.errors&&t.userForm.controls.invoiceNumber.touched),e.xp6(5),e.Q6J("readonly",t.userForm.controls.invoiceNumber.invalid),e.xp6(1),e.Q6J("ngIf",t.userForm.controls.rut.errors&&t.userForm.controls.rut.touched),e.xp6(5),e.Q6J("disabled",""==t.userForm.controls.invoiceNumber.value),e.xp6(3),e.Q6J("ngForOf",t.dbBusiness),e.xp6(2),e.Q6J("ngIf",t.businessNoFound&&t.userForm.controls.rut.touched),e.xp6(6),e.Q6J("ngIf",t.userForm.controls.treatmentType.errors&&t.userForm.controls.treatmentType.touched),e.xp6(6),e.Q6J("ngIf",t.userForm.controls.material.errors&&t.userForm.controls.material.touched),e.xp6(6),e.Q6J("ngIf",t.userForm.controls.entryDate.errors&&t.userForm.controls.entryDate.touched),e.xp6(6),e.Q6J("ngIf",t.userForm.controls.totalWeight.errors&&t.userForm.controls.totalWeight.touched),e.xp6(11),e.Q6J("ngIf",t.userForm.controls.valuedWeight.errors&&t.userForm.controls.valuedWeight.touched),e.xp6(5),e.Q6J("value",t.calculateRemainingWeight()),e.xp6(1),e.Q6J("ngIf",t.isRemainingWeightNegative),e.xp6(11),e.Q6J("ngIf",t.userForm.controls.attachment.errors&&t.userForm.controls.attachment.touched),e.xp6(4),e.Q6J("disabled",t.userForm.invalid||t.isRemainingWeightNegative))},dependencies:[S.mk,S.sg,S.O5,s._Y,s.YN,s.Kr,s.Fj,s.Wl,s.EJ,s.JJ,s.JL,s.Q7,s.sg,s.u,s.On,S.uU],styles:["[_nghost-%COMP%]{width:90%!important;padding:1%}.color-verde[_ngcontent-%COMP%]{color:green}.color-verde-opaco[_ngcontent-%COMP%]{color:#0080004d}.custom-cursor[_ngcontent-%COMP%]{cursor:pointer}.no-pointer[_ngcontent-%COMP%]{cursor:default}.example-section[_ngcontent-%COMP%]{margin:0 50px}"]}),a})();var rt=p(263);let st=(()=>{class a{constructor(o,t,n){this.fb=o,this.authService=t,this.router=n,this.pos="right",this.horaIngreso=new Date,this.formData=this.fb.group({actual:["",[s.kI.required]],password:["",[s.kI.required,s.kI.minLength(3)]],repeatPassword:["",[s.kI.required,s.kI.minLength(3)]]})}ngOnInit(){this.userData=JSON.parse(sessionStorage.getItem("user")),this.horaIngreso=new Date(sessionStorage.getItem("horaIngreso")),localStorage.removeItem("statementsState")}btnrecovery(){const{actual:o,password:t,repeatPassword:n}=this.formData.value;this.authService.modifyPassword(t,n,o).subscribe({next:i=>{i.status?(r().fire({title:"Cambio de contrase\xf1a",text:"La contrase\xf1a fue cambiada exitosamente",icon:"success"}),this.router.navigate(["/gestor/home"])):(r().fire({title:"Validar informaci\xf3n",text:i.msg,icon:"error"}),this.formData.reset())},error:i=>{r().fire({title:"Formato inv\xe1lido",text:"Contrase\xf1a debe contener al menos 8 caracteres",icon:"error"})}})}displayModifyPassword(){this.pos="right"==this.pos?"down":"right"}}return a.\u0275fac=function(o){return new(o||a)(e.Y36(s.qu),e.Y36(rt.e),e.Y36(U.F0))},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-profile"]],decls:81,vars:16,consts:[[1,"container","mt-4"],[1,"mi-perfil"],[1,"box","box-mi-perfil","mb-5","d-flex","align-items-start"],[1,"list","list-data","list-data-title-green","column-md-2","gap-0","list-unstyled"],[1,"list-data__title"],[1,"list-data__text"],[1,"color-verde"],[1,"list","list-links","list-unstyled"],["id","accordionPanelsStayOpenExample",1,"accordion","accordion-flush"],[1,"accordion-item"],["id","panelsStayOpen-headingOne",1,"accordion-header"],["data-bs-toggle","collapse","data-bs-target","#panelsStayOpen-collapseOne",3,"click"],["aria-hidden","true"],["id","panelsStayOpen-collapseOne","aria-labelledby","panelsStayOpen-headingOne",1,"accordion-collapse","collapse"],[1,"accordion-body"],["autocomplete","off",1,"form-recovery",3,"formGroup"],[1,"mb-4"],[1,"input-group"],[1,"input-group-text","input-group-text-left"],["aria-hidden","true",1,"fa","fa-lock","fa-fw"],["type","password","id","password","formControlName","actual","placeholder","Contrase\xf1a actual",1,"form-control"],["type","password","id","password","formControlName","password","placeholder","Nueva contrase\xf1a",1,"form-control"],["type","password","id","repeatPassword","formControlName","repeatPassword","placeholder","Repetir contrase\xf1a",1,"form-control"],["type","button",1,"btn","btn-primary","btn-fa","w-100",3,"click"],["aria-hidden","true",1,"fa","fa-long-arrow-right","fa-fw"]],template:function(o,t){1&o&&(e.TgZ(0,"div",0)(1,"section",1)(2,"h1"),e._uU(3,"Mi Perfil"),e.qZA(),e.TgZ(4,"div",2)(5,"ul",3)(6,"li")(7,"span",4),e._uU(8,"Nombre Usuario"),e.qZA(),e.TgZ(9,"span",5),e._uU(10),e.qZA()(),e.TgZ(11,"li")(12,"span",4),e._uU(13,"Perfil"),e.qZA(),e.TgZ(14,"span",5),e._uU(15),e.qZA()(),e.TgZ(16,"li")(17,"span",4),e._uU(18,"Tel\xe9fono"),e.qZA(),e.TgZ(19,"span",5),e._uU(20),e.qZA()(),e.TgZ(21,"li")(22,"span",4),e._uU(23,"Correo"),e.qZA(),e.TgZ(24,"span",5),e._uU(25),e.qZA()(),e.TgZ(26,"li")(27,"span",4),e._uU(28,"Instituci\xf3n"),e.qZA(),e.TgZ(29,"span",5),e._uU(30),e.qZA()(),e.TgZ(31,"li")(32,"span",4),e._uU(33,"Cargo"),e.qZA(),e.TgZ(34,"span",5),e._uU(35),e.qZA()(),e.TgZ(36,"li")(37,"span",4),e._uU(38,"Tel\xe9fono Oficina"),e.qZA(),e.TgZ(39,"span",5),e._uU(40),e.qZA()(),e.TgZ(41,"li")(42,"span",4)(43,"b"),e._uU(44,"Fecha/ Hora ingreso"),e.qZA()(),e.TgZ(45,"span",5),e._uU(46),e.ALo(47,"date"),e.qZA()()()(),e.TgZ(48,"h2",6),e._uU(49,"Acciones"),e.qZA(),e.TgZ(50,"ul",7)(51,"div",8)(52,"div",9)(53,"h2",10)(54,"li",11),e.NdJ("click",function(){return t.displayModifyPassword()}),e.TgZ(55,"a")(56,"span"),e._uU(57,"Cambio de contrase\xf1a"),e.qZA(),e._UZ(58,"i",12),e.qZA()()(),e.TgZ(59,"div",13)(60,"div",14)(61,"form",15)(62,"div",16)(63,"div",17)(64,"button",18),e._UZ(65,"i",19),e.qZA(),e._UZ(66,"input",20),e.qZA()(),e.TgZ(67,"div",16)(68,"div",17)(69,"button",18),e._UZ(70,"i",19),e.qZA(),e._UZ(71,"input",21),e.qZA()(),e.TgZ(72,"div",16)(73,"div",17)(74,"button",18),e._UZ(75,"i",19),e.qZA(),e._UZ(76,"input",22),e.qZA()(),e.TgZ(77,"div",16)(78,"button",23),e.NdJ("click",function(){return t.btnrecovery()}),e._uU(79," Enviar "),e._UZ(80,"i",24),e.qZA()()()()()()()()()()),2&o&&(e.xp6(10),e.AsE("",t.userData.FIRST_NAME," ",t.userData.LAST_NAME,""),e.xp6(5),e.Oqu(t.userData.ROL_NAME),e.xp6(5),e.Oqu(t.userData.PHONE),e.xp6(5),e.Oqu(t.userData.EMAIL),e.xp6(5),e.Oqu(t.userData.BUSINESS.join(" || ")),e.xp6(5),e.Oqu(t.userData.POSITION),e.xp6(5),e.Oqu(t.userData.PHONE_OFFICE),e.xp6(6),e.Oqu(e.xi3(47,13,t.horaIngreso,"dd-MM-yyyy H:mm:s")),e.xp6(12),e.Gre("fa fa-chevron-",t.pos,""),e.xp6(3),e.Q6J("formGroup",t.formData))},dependencies:[s._Y,s.Fj,s.JJ,s.JL,s.sg,s.u,S.uU]}),a})();var ue=p(574),lt=p(3813);const ct=["fileInput"];function dt(a,l){if(1&a){const o=e.EpF();e.TgZ(0,"tr")(1,"td"),e._uU(2),e.qZA(),e.TgZ(3,"td"),e._uU(4),e.qZA(),e.TgZ(5,"td"),e._uU(6),e.qZA(),e.TgZ(7,"td"),e._uU(8),e.qZA(),e.TgZ(9,"td"),e._uU(10),e.qZA(),e.TgZ(11,"td"),e._uU(12),e.qZA(),e.TgZ(13,"td"),e._uU(14),e.qZA(),e.TgZ(15,"td"),e._uU(16),e.qZA(),e.TgZ(17,"td"),e._uU(18),e.qZA(),e.TgZ(19,"td"),e._uU(20),e.qZA(),e.TgZ(21,"td"),e._uU(22),e.qZA(),e.TgZ(23,"td"),e._uU(24),e.qZA(),e.TgZ(25,"td"),e._uU(26),e.qZA(),e.TgZ(27,"td"),e._uU(28),e.qZA(),e.TgZ(29,"td",26)(30,"input",27,17),e.NdJ("change",function(n){const c=e.CHM(o).index,m=e.oxw(2);return e.KtG(m.onInvoiceChange(n,c))}),e.qZA(),e.TgZ(32,"button",14),e.NdJ("click",function(){e.CHM(o);const n=e.MAs(31);return e.KtG(n.click())}),e._UZ(33,"i",18),e._uU(34," Cargar Factura "),e.qZA(),e.TgZ(35,"p"),e._uU(36),e.qZA()(),e.TgZ(37,"td"),e._UZ(38,"i",28),e.qZA()()}if(2&a){const o=l.$implicit,t=l.index,n=e.oxw(2);e.xp6(2),e.Oqu(o.nameBusiness),e.xp6(2),e.Oqu(o.establishment),e.xp6(2),e.Oqu(o.treatmentType),e.xp6(2),e.Oqu(o.material),e.xp6(2),e.Oqu(o.subMaterial),e.xp6(2),e.Oqu(o.withdrawalDate.replaceAll("/","-")),e.xp6(2),e.Oqu(o.numberInvoice),e.xp6(2),e.Oqu(o.vat),e.xp6(2),e.Oqu(o.vatCompanyName),e.xp6(2),e.Oqu(o.frontAdmissionDate),e.xp6(2),e.Oqu(o.totalWeightFormated),e.xp6(2),e.Oqu(o.declaratedWeightFormated),e.xp6(2),e.Oqu(o.valuedWeightFormated),e.xp6(2),e.Oqu(o.fixedRemainingWeight.replace(".",",")),e.xp6(8),e.Oqu(n.fileNames[t]),e.xp6(2),e.Q6J("ngClass",n.fileNames[t]?"color-verde":"color-verde-opaco")}}function ut(a,l){if(1&a){const o=e.EpF();e.TgZ(0,"div",20)(1,"table",21)(2,"thead")(3,"tr",22)(4,"th"),e._uU(5,"Empresa CI"),e.qZA(),e.TgZ(6,"th"),e._uU(7,"Establecimiento"),e.qZA(),e.TgZ(8,"th"),e._uU(9,"Tipo Tratamiento"),e.qZA(),e.TgZ(10,"th"),e._uU(11,"Material"),e.qZA(),e.TgZ(12,"th"),e._uU(13,"Subtipo"),e.qZA(),e.TgZ(14,"th"),e._uU(15,"Fecha Retiro"),e.qZA(),e.TgZ(16,"th"),e._uU(17,"N\xfam. Factura Reciclador"),e.qZA(),e.TgZ(18,"th"),e._uU(19,"Rut Reciclador"),e.qZA(),e.TgZ(20,"th"),e._uU(21,"Reciclador"),e.qZA(),e.TgZ(22,"th"),e._uU(23,"Fecha ingreso PR"),e.qZA(),e.TgZ(24,"th"),e._uU(25,"Peso Total"),e.qZA(),e.TgZ(26,"th"),e._uU(27,"Peso Declarado"),e.qZA(),e.TgZ(28,"th"),e._uU(29,"Peso Valorizado"),e.qZA(),e.TgZ(30,"th"),e._uU(31,"Peso Remanente"),e.qZA(),e.TgZ(32,"th"),e._uU(33,"Carga Factura"),e.qZA(),e.TgZ(34,"th"),e._uU(35,"Estado"),e.qZA()()(),e.TgZ(36,"tbody"),e.YNc(37,dt,39,16,"tr",23),e.qZA(),e.TgZ(38,"tbody")(39,"tr"),e._UZ(40,"td")(41,"td")(42,"td")(43,"td")(44,"td")(45,"td")(46,"td")(47,"td")(48,"td")(49,"td")(50,"td")(51,"td")(52,"td")(53,"td"),e.TgZ(54,"td",24)(55,"button",25),e.NdJ("click",function(){e.CHM(o);const n=e.oxw();return e.KtG(n.saveAllInvoices())}),e._uU(56," Finalizar "),e.qZA()()()()()()}if(2&a){const o=e.oxw();e.xp6(37),e.Q6J("ngForOf",o.allInvoices),e.xp6(18),e.Q6J("ngClass",o.verification==o.allInvoices.length?"":"disabled")}}let mt=(()=>{class a{constructor(o,t,n){this.establishmentService=o,this.managerService=t,this.businessService=n,this.dbBusiness=[],this.invoices=[],this.invoicesDuplicated=[],this.allInvoices=[],this.index=0,this.fileNames={},this.verification=0,this.fileToUpload={},this.wasteTypes={PapelCart\u00f3n:["Papel","Papel Compuesto (cemento)","Caja Cart\xf3n","Papel/Cart\xf3n Otro"],Metal:["Envase Aluminio","Malla o Reja (IBC)","Envase Hojalata","Metal Otro"],Pl\u00e1stico:["Pl\xe1stico Film Embalaje","Pl\xe1stico Envases R\xedgidos (Incl. Tapas)","Pl\xe1stico Sacos o Maxisacos","Pl\xe1stico EPS (Poliestireno Expandido)","Pl\xe1stico Zuncho","Pl\xe1stico Otro"],Madera:["Caja de Madera","Pallet de Madera"]}}ngOnInit(){this.userData=JSON.parse(sessionStorage.getItem("user")),localStorage.removeItem("statementsState")}downloadExcel(){r().fire({title:"Generando Excel",text:"Esto puede tardar varios minutos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1}),r().showLoading(),this.managerService.downloadExcelTemplateInvoice().subscribe({next:o=>{if(o){const t=new Blob([o],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8"});let n=document.createElement("a");n.href=window.URL.createObjectURL(t),n.download="carga masiva gestor",document.body.appendChild(n),n.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),n.remove(),window.URL.revokeObjectURL(n.href),r().close()}},error:o=>{if(o instanceof Blob){const t=new FileReader;t.onload=()=>{const n=t.result;try{const i=JSON.parse(n);!1===i.status&&i.message?r().fire({icon:"error",text:i.message}):r().fire({icon:"error",text:"Documento para carga masiva no disponible."})}catch{r().fire({icon:"error",text:"Error desconocido al procesar la respuesta."})}},t.readAsText(o)}else r().fire({icon:"error",text:"Error desconocido al procesar la respuesta."})}})}onFileChange(o){const n=o.target;if(1!==n.files.length)return void r().fire({icon:"error",text:"Solo puede cargar un archivo a la vez"});const i=n.files[0];if(!["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(i.type))return void r().fire({icon:"error",text:"Tipo de archivo incorrecto. Por favor, cargue un archivo Excel (.xls o .xlsx)"});if(n.files[0].size>1048576)return void r().fire({icon:"error",text:"Tama\xf1o del archivo excede el l\xedmite (1MB m\xe1ximo)."});const Z=new FileReader;Z.onload=_=>{const T=ue.ij(_.target.result,{type:"binary"});if(!T.SheetNames.includes("Carga Masiva"))return void r().fire({icon:"error",text:'No se encontr\xf3 la hoja "Carga Masiva" en el archivo.'});const F=ue.P6.sheet_to_json(T.Sheets["Carga Masiva"],{header:1});this.processData(F)},Z.readAsBinaryString(i),this.resetFileInput()}resetFileInput(){this.fileInput.nativeElement.value=""}onInvoiceChange(o,t){const i=o.target;if(i.files.length>1)return void r().fire({icon:"error",text:"Solo puede cargar un archivo a la vez"});if(!["application/pdf","image/jpeg"].includes(i.files[0].type))return void r().fire({icon:"error",text:"Tipo de archivo incorrecto. Por favor, cargue un archivo v\xe1lido (.pdf, .jpeg o .jpg)"});if(i.files[0].size>1048576)return void r().fire({icon:"error",text:"Tama\xf1o del archivo excede el l\xedmite (1MB m\xe1ximo)."});const _=o.target.files[0];_&&(this.fileNames[t]=_.name,this.fileToUpload[t]=_,this.verification=Object.keys(this.fileNames).length),this.resetFileInput()}processData(o){var t=this;return(0,N.Z)(function*(){if(r().fire({title:"Procesando datos",text:"Se estan validando los datos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1}),r().showLoading(),0==o.length)return void r().fire({icon:"error",text:"Archivo inv\xe1lido. No tiene todas las columnas necesarias"});const n=o.slice(1).filter(u=>u.length>0&&u.some(d=>d)),i=[],c=[];if(0==n.length)return void r().fire({icon:"info",text:"Archivo inv\xe1lido, verifique que no est\xe9 vac\xedo."});if(13!=o[0].length)return void r().fire({icon:"error",text:"Archivo inv\xe1lido, no tiene todas las columnas necesarias."});const Z=(yield t.establishmentService.getDeclarationEstablishment().toPromise()).status.filter(u=>0===u.STATE_GESTOR),_=yield t.managerService.getAllMaterials().toPromise(),x=yield t.managerService.getAllTreatments().toPromise(),T=yield t.businessService.getAllBusiness().toPromise(),I=new Set;for(let u=0;u<n.length;u++){const d=n[u],h=u+2;if(0==d.length&&0==u)return void r().fire({icon:"error",text:"Archivo vac\xedo"});const O=d[0];if(!O)return void r().fire({icon:"error",text:`Empresa CI no ingresado en la fila ${h}`});const R=d[1];if(!R)return void r().fire({icon:"error",text:`Establecimiento no ingresado en la fila ${h}`});const J=d[2];if(!J)return void r().fire({icon:"error",text:`Tipo de tratamiento no ingresado en la fila ${h}`});const L=d[3];if(!L)return void r().fire({icon:"error",text:`Material no ingresado en la fila ${h}`});const X=d[4];if(!X)return void r().fire({icon:"error",text:`Subtipo no ingresado en la fila ${h}`});const me=d[5];if(!me)return void r().fire({icon:"error",text:`Fecha retiro no ingresado en la fila ${h}`});const Y=d[6];if(!Y)return void r().fire({icon:"error",text:`Numero factura no ingresado en la fila ${h}`});if(Y<=0)return void r().fire({icon:"error",text:`Numero factura ingresado en la fila ${h} debe ser mayor que cero`});const B=d[7];if(!B)return void r().fire({icon:"error",text:`RUT no ingresado en la fila ${h}`});let ee;const te=_.status.find(g=>g.MATERIAL===L);if(!te)return void r().fire({icon:"error",text:`No se encontr\xf3 ningun material con el nombre "${L}" en la fila ${h}`});let oe;te&&(ee=te.ID);const ne=x.status.find(g=>g.NAME===J);if(!ne)return void r().fire({icon:"error",text:`No se encontr\xf3 ningun tipo de tratamiento con el nombre "${J}" en la fila ${h}`});ne&&(oe=ne.ID);const j=d[8];if(!j)return void r().fire({icon:"error",text:`Reciclador no ingresado en la fila ${h}`});let pe;const ae=T.status.find(g=>g.NAME===j&&g.VAT===B);if(!ae)return void r().fire({icon:"error",text:`No se encontr\xf3 ningun reciclador con el nombre "${j}" asociado al rut "${B}" en la fila ${h}`});ae&&(pe=ae.ID);const ie=d[9];if(!ie)return void r().fire({icon:"error",text:`Fecha ingreso PR no ingresado en la fila ${h}`});const he=t.isValidDate(ie);if(!he.valid)return void r().fire({icon:"error",text:`Error en la fila ${h}. ${he.message}`});let q,M,V;const z=yield t.establishmentService.getInovice(Y,B,oe,ee).toPromise();if(!z.status)return void r().fire({icon:"error",text:`La fila ${h} tiene el siguiente error: `+z.msg});if(q=t.formatNumber(z.data[0]?.invoice_value),V=t.formatNumber(z.data[0].value_declarated),0==q&&!d[10])return void r().fire({icon:"error",text:`Peso total no ingresado en la fila ${h}`});if(0==q&&(q=d[10]),0!==q&&q!==d[10])return void r().fire({icon:"info",text:`La factura con numero ${Y} de la fila ${h} ya cuenta con datos existentes, favor de ingresar el peso total registrado previamente (${q})`});const _t=q.replace(",","."),ge=parseFloat(_t);if(isNaN(ge))return void r().fire({icon:"error",text:`Peso total ingresado en la fila ${h} no es v\xe1lido, debe ser solo n\xfameros y con comas.`});if(ge<=0)return void r().fire({icon:"error",text:`Peso total ingresado en la fila ${h} debe ser mayor que cero.`});if(M=d[11],0==M&&!d[11])return void r().fire({icon:"error",text:`Peso declarado no ingresado en la fila ${h}`});0==M&&(M=d[11]);const P=d[12];if(!P)return void r().fire({icon:"error",text:`Peso valorizado no ingresado en la fila ${h}`});const Tt=P.replace(",","."),fe=parseFloat(Tt);if(isNaN(fe))return void r().fire({icon:"error",text:`Peso valorizado ingresado en la fila ${h} no es v\xe1lido, debe ser solo n\xfameros y con comas.`});if(fe<=0)return void r().fire({icon:"error",text:`Peso valorizado ingresado en la fila ${h} debe ser mayor que cero.`});const _e=parseFloat(q.toString().replace(",",".")),Te=parseFloat(P.toString().replace(",","."));let Q;if(0!==V){const f=_e-parseFloat(V.toString().replace(",",".")),Ae=f-Te;if(Q=Ae.toFixed(2).replace(".",","),Ae<0)return void r().fire({icon:"error",text:`Peso remanente calculado en la fila ${h} no puede ser menor que cero.\n ${f} - ${P}  = ${Q}`})}if(0==V){const g=_e-Te;if(Q=g.toFixed(2).replace(".",","),g<0)return void r().fire({icon:"error",text:`Peso remanente calculado en la fila ${h} no puede ser menor que cero.\n ${q} - ${P}  = ${Q}`})}for(let g=u+1;g<n.length;g++){const f=n[g];if(f[2]!==d[2]&&f[3]===d[3]&&f[6]===d[6]&&f[7]===d[7])return void r().fire({icon:"info",text:`Distintos tipos de tratamiento con el mismo tipo de material, N\xfam de factura reciclador y rut reciclador en las filas ${u+2} y ${g+2}`});if(f[2]===d[2]&&f[3]!==d[3]&&f[6]===d[6]&&f[7]===d[7])return void r().fire({icon:"info",text:`Distintos tipos de material con el mismo tipo de tratamiento, N\xfam de factura reciclador y rut reciclador en las filas ${u+2} y ${g+2}`});if(f[2]!==d[2]&&f[3]!==d[3]&&f[6]===d[6]&&f[7]===d[7])return void r().fire({icon:"info",text:`Distintos tipos de tratamiento y material con el mismo N\xfam de factura reciclador y rut reciclador en las filas ${u+2} y ${g+2}`});if(f[2]===d[2]&&f[3]===d[3]&&f[6]===d[6]&&f[7]===d[7]&&f[10]!==d[10])return void r().fire({icon:"info",text:`Ingresar el mismo peso total para todas las facturas iguales con numero ${d[6]}`});f[2]===d[2]&&f[3]===d[3]&&f[6]===d[6]&&f[7]===d[7]&&f[10]===d[10]&&(I.add(d),I.add(f))}const ve=d[13],re=ie.split("/"),be=new Date(`${re[2]}-${re[1]}-${re[0]}`).toISOString().split("T")[0],se=be.split("-"),bt=`${se[2]}-${se[1]}-${se[0]}`;if(!Z.find(g=>g.NAME_BUSINESS===O&&g.NAME_ESTABLISHMENT_REGION===R&&g.TipoTratamiento===J&&g.PRECEDENCE===L&&g.TYPE_RESIDUE===X&&g.VALUE===parseFloat(d[11])&&g.ID_DETAIL==parseInt(ve)))return void r().fire({icon:"error",text:`No se encontr\xf3 ninguna factura pendiente en la base de datos con los registros de la fila ${h}`});const Zt=parseFloat(q.replace(",",".")).toFixed(2).replace(".",",").toString(),At=parseFloat(P.replace(",",".")).toFixed(2).replace(".",",").toString();let le;"number"==typeof M&&(le=parseFloat(M.toString().replace(",",".")).toFixed(2).replace(".",",").toString()),"string"==typeof M&&(le=parseFloat(M.replace(",",".")).toFixed(2).replace(".",",").toString());const Ze={nameBusiness:O,idBusiness:pe,establishment:R,treatmentType:J,material:L,subMaterial:X,withdrawalDate:me,numberInvoice:Y,vat:B,vatCompanyName:j,backAdmissionDate:be,totalWeight:q,declaratedWeight:M,valuedWeight:P,fixedRemainingWeight:Q,idDetail:ve,frontAdmissionDate:bt,totalWeightFormated:Zt,valuedWeightFormated:At,declaratedWeightFormated:le,declaratedWeightResponse:V,materialTypeNum:ee,treatmentTypeNum:oe};let ce=!1;for(const g of I)g.includes(B)&&(ce=!0);0==ce&&i.push(Ze),1==ce&&c.push(Ze)}const F={};let A=null,y=null;for(const u of c){const d=`${u.vat}`;F[d]||(F[d]={tipo_tratamiento:u.treatmentType,material:u.material,numero_factura:u.numberInvoice,rut_reciclador:u.vat,remanente_total:0}),null===A&&null===y&&(A=0!==parseFloat(u.declaratedWeightResponse)?parseFloat(u.totalWeight.toString().replace(",","."))-parseFloat(u.declaratedWeightResponse.toString().replace(",",".")):parseFloat(u.totalWeight.replace(",",".")),y=u.vat),y!=u.vat&&(A=0!==parseFloat(u.declaratedWeightResponse)?parseFloat(u.totalWeight.toString().replace(",","."))-parseFloat(u.declaratedWeightResponse.toString().replace(",",".")):parseFloat(u.totalWeight.replace(",",".")),y=u.vat),A-=parseFloat(u.valuedWeight.replace(",",".")),u.fixedRemainingWeight=A.toFixed(2).replace(".",",").toString(),F[d].remanente_total=A}for(const u in F)if(F.hasOwnProperty(u)){const d=F[u].remanente_total;if(d<0)return void r().fire({icon:"error",text:`Los remanentes totales para las facturas con numero ${u} son menores a cero: ${d}`})}t.invoices=i,t.invoicesDuplicated=c,t.allInvoices=Array.from([...i,...c]),r().close()})()}saveAllInvoices(){var o=this;return(0,N.Z)(function*(){r().fire({title:"Ingresando datos",text:"Se estan cargando los datos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1}),r().showLoading();let t=!1;for(let n=0;n<o.allInvoices.length;n++){const i=o.allInvoices[n];if(o.allInvoices.length==Object.keys(o.fileNames).length&&o.fileNames[n])try{if(!(yield Promise.race([o.establishmentService.saveInvoice(i.vat,i.idBusiness,i.numberInvoice,i.idDetail,i.backAdmissionDate,i.valuedWeight.replace(",","."),i.totalWeight.replace(",","."),i.treatmentTypeNum,i.materialTypeNum,o.fileToUpload[n]).toPromise(),new Promise((m,Z)=>{setTimeout(()=>Z(new Error("Timeout")),3e4)})])).status)return t=!0,o.allInvoices=[],r().close(),void r().fire({icon:"error",text:"Ha habido un error y el proceso se ha detenido, consulte m\xe1s tarde el estado de sus declaraciones para ver cuales fueron exitosamente aprobadas y cuales no."})}catch(c){if("Timeout"===c.message)return t=!0,o.allInvoices=[],r().close(),void r().fire({icon:"error",text:"Ha habido un error y el proceso se ha detenido, consulte m\xe1s tarde el estado de sus declaraciones para ver cuales fueron exitosamente aprobadas y cuales no."});throw t=!0,o.allInvoices=[],r().close(),r().fire({icon:"error",text:"Ha habido un error y el proceso se ha detenido, consulte m\xe1s tarde el estado de sus declaraciones para ver cuales fueron exitosamente aprobadas y cuales no."}),c}}o.allInvoices=[],t||(r().close(),r().fire({icon:"success",text:"Sus facturas han sido ingresadas correctamente"}))})()}formatNumber(o){return null==o?"":Number.isInteger(o)?o.toString():o.toLocaleString("es")}isValidDate(o){if(typeof o>"u"||""===o.trim())return{valid:!1,message:"Fecha no puede estar vac\xeda."};const t=o.split("/");if(3!==t.length||isNaN(+t[0])||isNaN(+t[1])||isNaN(+t[2]))return{valid:!1,message:"Formato de la fecha es incorrecto. Formato requerido: DD/MM/AAAA"};const n=new Date(+t[2],+t[1]-1,+t[0]),i=new Date;return i.setHours(0,0,0,0),n>i?{valid:!1,message:"Fecha no debe ser futura."}:n.getDate()!==+t[0]||n.getMonth()!==+t[1]-1||n.getFullYear()!==+t[2]?{valid:!1,message:"Fecha proporcionada no es v\xe1lida."}:{valid:!0,message:""}}}return a.\u0275fac=function(o){return new(o||a)(e.Y36(k.d),e.Y36(lt.b),e.Y36(W.m))},a.\u0275cmp=e.Xpm({type:a,selectors:[["app-bulk-upload"]],viewQuery:function(o,t){if(1&o&&e.Gf(ct,5),2&o){let n;e.iGM(n=e.CRH())&&(t.fileInput=n.first)}},decls:28,vars:1,consts:[[1,"container","mt-4"],["aria-label","breadcrumb",1,"breadcrumbs","d-none","d-lg-block"],[1,"breadcrumb"],[1,"breadcrumb-item"],["href","#"],["aria-hidden","true",1,"fa","fa-home"],["aria-current","page",1,"breadcrumb-item","active"],[1,"declaracion"],[1,"d-sm-flex","justify-content-between","mb-3","mb-md-0"],[1,"box","box-form","mb-4"],[1,"row","align-items-end"],[1,"col-12","col-xl-12"],[1,"row"],[1,"col-6"],[1,"btn","btn-primary","col-12",3,"click"],[1,"fas","fa-download"],["type","file","id","file-input","accept",".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",2,"display","none",3,"change"],["fileInput",""],[1,"fas","fa-upload"],["class","box box-form mb-12",4,"ngIf"],[1,"box","box-form","mb-12"],[1,"table","table-even","table-section","table-borderless","table-radius"],["align","center"],[4,"ngFor","ngForOf"],["colspan","2"],[1,"btn","btn-primary","col-12",3,"ngClass","click"],[2,"width","1000px"],["type","file","id","file-input","accept",".pdf,.jpeg,.jpg",2,"display","none",3,"change"],["aria-hidden","true","id","submit",1,"fa","fa-check","fa-lg","fa-fw",3,"ngClass"]],template:function(o,t){if(1&o){const n=e.EpF();e.TgZ(0,"div",0)(1,"nav",1)(2,"ol",2)(3,"li",3)(4,"a",4),e._UZ(5,"i",5),e._uU(6," Inicio"),e.qZA()(),e.TgZ(7,"li",6),e._uU(8,"Carga Masiva Factura Reciclador"),e.qZA()()(),e.TgZ(9,"section",7)(10,"h1"),e._uU(11,"Carga Masiva Factura Reciclador"),e.qZA(),e._UZ(12,"div",8),e.TgZ(13,"div",9)(14,"div",10)(15,"div",11)(16,"div",12)(17,"div",13)(18,"button",14),e.NdJ("click",function(){return t.downloadExcel()}),e._UZ(19,"i",15),e._uU(20," Descargar declaraciones pendientes por aprobar "),e.qZA()(),e.TgZ(21,"div",13)(22,"input",16,17),e.NdJ("change",function(c){return t.onFileChange(c)}),e.qZA(),e.TgZ(24,"button",14),e.NdJ("click",function(){e.CHM(n);const c=e.MAs(23);return e.KtG(c.click())}),e._UZ(25,"i",18),e._uU(26," Cargar declaraciones "),e.qZA()()()()()(),e.YNc(27,ut,57,2,"div",19),e.qZA()()}2&o&&(e.xp6(27),e.Q6J("ngIf",t.allInvoices.length>0))},dependencies:[S.mk,S.sg,S.O5],styles:["[_nghost-%COMP%]{width:90%!important;padding:1%}.color-verde[_ngcontent-%COMP%]{color:green}.color-verde-opaco[_ngcontent-%COMP%]{color:#0080004d}.circle[_ngcontent-%COMP%]{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:5px}.green-circle[_ngcontent-%COMP%]{background-color:green}.red-circle[_ngcontent-%COMP%]{background-color:red}"]}),a})();var pt=p(9314);const ht=[{path:"",component:D.$,children:[{path:"home",component:v},{path:"statements",component:it},{path:"profile",component:st},{path:"faq",component:pt.v},{path:"bulk-upload-invoice",component:mt},{path:"**",redirectTo:"home",pathMatch:"full"}]}];let gt=(()=>{class a{}return a.\u0275fac=function(o){return new(o||a)},a.\u0275mod=e.oAB({type:a}),a.\u0275inj=e.cJS({imports:[U.Bz.forChild(ht),U.Bz]}),a})(),ft=(()=>{class a{}return a.\u0275fac=function(o){return new(o||a)},a.\u0275mod=e.oAB({type:a}),a.\u0275inj=e.cJS({imports:[S.ez,gt,s.UX,s.u5]}),a})()}}]);