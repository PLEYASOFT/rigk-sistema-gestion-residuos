"use strict";(self.webpackChunkrigk_sg_web=self.webpackChunkrigk_sg_web||[]).push([[744],{9821:(se,R,p)=>{p.d(R,{d:()=>e});var Z=p(2340),N=p(529),U=p(8256);let e=(()=>{class T{constructor(s){this.http=s,this.url=`${Z.N.API_V1_URL}/establishment`}getAllEstablishment(){return this.http.get(`${this.url}/all/`)}getInovice(s,f,v){return this.http.post(`${this.url}/get/invoice/`,{invoice_number:s,treatment_type:f,material_type:v})}saveInvoice(s,f,v,i,B,w,P,j,z,V){const S=new FormData;return S.append("vat",s),S.append("id_business",f),S.append("invoice_number",v),S.append("id_detail",i),S.append("date_pr",B),S.append("value",w),S.append("valued_total",P),S.append("treatment",j),S.append("id_material",z),S.append("file",V,V.name),this.http.post(`${this.url}/invoice/`,S)}addEstablishment(s,f,v,i,B,w,P){return this.http.post(`${this.url}/add/`,{name:s,name_region:f,v_unica:v,id_region:i,id_comuna:B,address:w,id_business:P})}deleteEstablishment(s){return this.http.delete(`${this.url}/delete/${s}`)}getEstablishment(s){return this.http.get(`${this.url}/${s}`)}getEstablishmentByID(s){return this.http.get(`${this.url}/get/${s}`)}getIdByEstablishment(s,f,v,i){return this.http.get(`${this.url}/getIdByEstablishment/${s}/${f}/${v}/${i}`)}getDeclarationEstablishment(){return this.http.get(`${this.url}/declaration/`)}getDeclarationEstablishmentByIdGestor(s){const f={headers:new N.WM({"Content-Type":"application/json"})};return this.http.post(`${this.url}/declarationByIdGestor/`,{idGestors:s},f)}getAllDeclarationEstablishments(){return this.http.get(`${this.url}/alldeclaration/`)}}return T.\u0275fac=function(s){return new(s||T)(U.LFG(N.eN))},T.\u0275prov=U.Yz7({token:T,factory:T.\u0275fac,providedIn:"root"}),T})()},3813:(se,R,p)=>{p.d(R,{b:()=>e});var Z=p(2340),N=p(529),U=p(8256);let e=(()=>{class T{constructor(s){this.http=s,this.url=`${Z.N.API_V1_URL}/manager`}getAllManager(){return this.http.get(`${this.url}/all/`)}addManager(s,f,v,i){return this.http.post(`${this.url}/add/`,{type_material:s,region:f,id_business:v,id_region:i})}deleteManager(s){return this.http.delete(`${this.url}/delete/${s}`)}getManager(s){return this.http.get(`${this.url}/${s}`)}getAllMaterials(){return this.http.get(`${this.url}/allMaterials/`)}getAllTreatments(){return this.http.get(`${this.url}/allTreatments/`)}getAllRegions(){return this.http.get(`${this.url}/regiones/`)}getRegionFromID(s){return this.http.get(`${this.url}/regiones/${s}/`)}getAllCommunes(){return this.http.get(`${this.url}/comunas/`)}getCommunesFormatted(){return this.http.get(`${this.url}/communesFormatted/`)}getAllSubmaterial(){return this.http.get(`${this.url}/submaterial/`)}getAllSubmaterialFormatted(){return this.http.get(`${this.url}/submaterialFormatted/`)}getManagersByMaterials(s,f){const v=s.join(",");return this.http.get(`${this.url}/materials/${v}/region/${f}`)}downloadExcelTemplateInvoice(s){let f=new N.WM;return f=f.set("Accept","application/vnd.ms-excel"),this.http.post(`${this.url}/excel`,{idGestors:s},{headers:f,responseType:"blob"})}}return T.\u0275fac=function(s){return new(s||T)(U.LFG(N.eN))},T.\u0275prov=U.Yz7({token:T,factory:T.\u0275fac,providedIn:"root"}),T})()},3744:(se,R,p)=>{p.r(R),p.d(R,{ManagerStatementModule:()=>ft});var Z=p(6895),N=p(5792),U=p(4135),e=p(8256);let T=(()=>{class r{constructor(){}ngOnInit(){}}return r.\u0275fac=function(o){return new(o||r)},r.\u0275cmp=e.Xpm({type:r,selectors:[["app-home"]],decls:22,vars:0,consts:[["id","content"],["aria-label","breadcrumb",1,"breadcrumbs","d-none","d-lg-block"],[1,"breadcrumb"],["aria-current","page",1,"breadcrumb-item"],["aria-hidden","true",1,"fa","fa-home"],[1,"inicio"],[1,"box","box-inicio"],[1,"row"],[1,"col-12","col-md-8"],[1,"h1"],[2,"visibility","hidden"]],template:function(o,t){1&o&&(e.TgZ(0,"div",0)(1,"nav",1)(2,"ol",2)(3,"li",3),e._UZ(4,"i",4),e._uU(5," Inicio"),e.qZA()()(),e.TgZ(6,"section",5)(7,"h1"),e._uU(8,"Inicio"),e.qZA(),e.TgZ(9,"div",6)(10,"div",7)(11,"div",8)(12,"h2",9),e._uU(13,"Bienvenido/a a M\xf3dulo de Gestores"),e.qZA(),e.TgZ(14,"p",10),e._uU(15,"Como parte de las obligaciones que establece la Ley REP, los Productores deben informar la cantidad de EyE no domiciliarios (POM) puestos en el mercado el a\xf1o anterior."),e.qZA(),e.TgZ(16,"p",10),e._uU(17,"ProREP pone a disposici\xf3n de sus socios la plataforma de declaraci\xf3n que dar\xe1 cumplimiento a la obligaci\xf3n de informar sus EyE."),e.qZA(),e.TgZ(18,"p",10),e._uU(19,"La informaci\xf3n deber\xe1 subirse en los meses de enero y febrero."),e.qZA(),e.TgZ(20,"p",10),e._uU(21,"En caso de tener dudas con respecto a su declaraci\xf3n puede ver los tutoriales y preguntas frecuentes."),e.qZA()()()()()())}}),r})();var F=p(5861),s=p(433),f=p(3224),v=p(5226),i=p.n(v),B=p(371),w=p(9821),P=p(8195);function j(r,l){if(1&r&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&r){const o=l.$implicit;e.s9C("value",o),e.xp6(1),e.Oqu(o)}}function z(r,l){if(1&r&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&r){const o=l.$implicit;e.s9C("value",o),e.xp6(1),e.Oqu(o)}}function V(r,l){if(1&r&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&r){const o=l.$implicit;e.s9C("value",o),e.xp6(1),e.Oqu(o)}}function S(r,l){if(1&r&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&r){const o=l.$implicit;e.s9C("value",o),e.xp6(1),e.Oqu(o)}}function Se(r,l){if(1&r&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&r){const o=l.$implicit,t=e.oxw();e.Q6J("value",o),e.xp6(1),e.Oqu(t.getStateText(o))}}function Ae(r,l){1&r&&(e.ynx(0),e.TgZ(1,"th"),e._uU(2,"Aprobar"),e.qZA(),e.BQk())}function Ce(r,l){1&r&&(e.TgZ(0,"span"),e._uU(1,"Por aprobar"),e.qZA())}function Fe(r,l){1&r&&(e.TgZ(0,"span"),e._uU(1,"Aprobado"),e.qZA())}const Ee=function(r){return{"no-pointer":r}};function xe(r,l){if(1&r){const o=e.EpF();e.ynx(0),e.TgZ(1,"td")(2,"a",67),e.NdJ("click",function(){e.CHM(o);const n=e.oxw(),a=n.index,c=n.$implicit,u=e.oxw();return u.handleClick(a,c.STATE_GESTOR),e.KtG(u.selectedDeclarationsCount=0)}),e._UZ(3,"i",68),e.qZA()(),e.BQk()}if(2&r){const o=e.oxw().$implicit;e.xp6(2),e.Q6J("ngClass",e.VKq(3,Ee,0!==o.STATE_GESTOR)),e.uIk("data-bs-target",0==o.STATE_GESTOR?"#infoModal":null),e.xp6(1),e.Q6J("ngClass",0==o.STATE_GESTOR?"color-verde-opaco":"color-verde")}}function Ne(r,l){if(1&r){const o=e.EpF();e.TgZ(0,"tr")(1,"td")(2,"section",66)(3,"input",27),e.NdJ("ngModelChange",function(n){const c=e.CHM(o).$implicit;return e.KtG(c.isChecked=n)})("change",function(){e.CHM(o);const n=e.oxw();return n.updateCheckboxSelection(),e.KtG(n.index=0)}),e.qZA()()(),e.TgZ(4,"td"),e._uU(5),e.qZA(),e.TgZ(6,"td"),e._uU(7),e.qZA(),e.TgZ(8,"td"),e._uU(9),e.qZA(),e.TgZ(10,"td"),e._uU(11),e.qZA(),e.TgZ(12,"td"),e._uU(13),e.qZA(),e.TgZ(14,"td"),e._uU(15),e.ALo(16,"date"),e.qZA(),e.TgZ(17,"td"),e.YNc(18,Ce,2,0,"span",28),e.YNc(19,Fe,2,0,"span",28),e.qZA(),e.TgZ(20,"td"),e._uU(21),e.qZA(),e.TgZ(22,"td"),e._uU(23),e.qZA(),e.YNc(24,xe,4,5,"ng-container",28),e.qZA()}if(2&r){const o=l.$implicit,t=e.oxw();e.xp6(3),e.Q6J("disabled",0!=o.STATE_GESTOR)("ngModel",o.isChecked),e.xp6(2),e.Oqu(o.NAME_BUSINESS),e.xp6(2),e.Oqu(o.NAME_ESTABLISHMENT_REGION),e.xp6(2),e.Oqu(o.TipoTratamiento),e.xp6(2),e.Oqu(o.PRECEDENCE),e.xp6(2),e.Oqu(o.TYPE_RESIDUE),e.xp6(2),e.Oqu(e.xi3(16,13,o.FechaRetiro,"dd-MM-yyyy")),e.xp6(3),e.Q6J("ngIf",0==o.STATE_GESTOR),e.xp6(1),e.Q6J("ngIf",0!=o.STATE_GESTOR),e.xp6(2),e.Oqu(t.replaceDot(o.VALUE)),e.xp6(2),e.Oqu(t.formatValue(o.VALUE_DECLARATE)),e.xp6(1),e.Q6J("ngIf",!t.anyCheckboxSelected)}}const qe=function(r,l){return{"btn-info":r,"btn-primary":l}};function ye(r,l){if(1&r){const o=e.EpF();e.TgZ(0,"li")(1,"button",69),e.NdJ("click",function(){const a=e.CHM(o).$implicit,c=e.oxw();return e.KtG(c.pagTo(a))}),e._uU(2),e.qZA()()}if(2&r){const o=l.$implicit,t=e.oxw();e.xp6(1),e.Q6J("ngClass",e.WLB(2,qe,t.pos===o+1,t.pos!==o+1)),e.xp6(1),e.Oqu(o+1)}}function Ie(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un n\xfamero de factura."),e.qZA())}function Ue(r,l){if(1&r&&(e.TgZ(0,"div",70),e.YNc(1,Ie,2,0,"p",28),e.qZA()),2&r){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.invoiceNumber.errors.required)}}function Me(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"El rut de la empresa es requerido."),e.qZA())}function De(r,l){if(1&r&&(e.TgZ(0,"div",51),e.YNc(1,Me,2,0,"p",28),e.qZA()),2&r){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.rut.errors.required)}}function Oe(r,l){1&r&&e._UZ(0,"input",71)}function Re(r,l){if(1&r&&(e.TgZ(0,"option",65),e._uU(1),e.qZA()),2&r){const o=l.$implicit;e.Q6J("value",o.ID),e.xp6(1),e.Oqu(o.NAME)}}function we(r,l){if(1&r&&(e.TgZ(0,"select",72)(1,"option",73),e._uU(2,"Seleccione Reciclador"),e.qZA(),e.YNc(3,Re,2,2,"option",15),e.qZA()),2&r){const o=e.oxw();e.Q6J("disabled",""==o.userForm.controls.invoiceNumber.value),e.xp6(3),e.Q6J("ngForOf",o.dbBusiness)}}function Pe(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1," Reciclador requerido. "),e.qZA())}function ke(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1," Por favor, seleccione un reciclador. "),e.qZA())}function We(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"El rut de la empresa es requerido."),e.qZA())}function Be(r,l){if(1&r&&(e.TgZ(0,"div",51),e.YNc(1,We,2,0,"p",28),e.qZA()),2&r){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.treatmentType.errors.required)}}function Je(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"El rut de la empresa es requerido."),e.qZA())}function $e(r,l){if(1&r&&(e.TgZ(0,"div",51),e.YNc(1,Je,2,0,"p",28),e.qZA()),2&r){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.material.errors.required)}}function Le(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar una fecha. "),e.qZA())}function Ve(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"La fecha no puede ser futura."),e.qZA())}function Ye(r,l){if(1&r&&(e.TgZ(0,"div",70),e.YNc(1,Le,2,0,"p",28),e.YNc(2,Ve,2,0,"p",28),e.qZA()),2&r){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.entryDate.errors.required),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.entryDate.errors.futureDate)}}function Qe(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un peso total."),e.qZA())}function Ge(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un n\xfamero v\xe1lido (con coma)."),e.qZA())}function je(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"El valor debe ser mayor que cero."),e.qZA())}function ze(r,l){if(1&r&&(e.TgZ(0,"div",70),e.YNc(1,Qe,2,0,"p",28),e.YNc(2,Ge,2,0,"p",28),e.YNc(3,je,2,0,"p",28),e.qZA()),2&r){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.totalWeight.errors.required),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.totalWeight.errors.pattern),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.totalWeight.errors.minStringValue)}}function He(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un peso valorizado."),e.qZA())}function Ke(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"Debe ingresar un n\xfamero v\xe1lido (Con coma)."),e.qZA())}function Xe(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"El valor debe ser mayor que cero."),e.qZA())}function et(r,l){if(1&r&&(e.TgZ(0,"div",70),e.YNc(1,He,2,0,"p",28),e.YNc(2,Ke,2,0,"p",28),e.YNc(3,Xe,2,0,"p",28),e.qZA()),2&r){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.valuedWeight.errors.required),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.valuedWeight.errors.pattern),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.valuedWeight.errors.minStringValue)}}function tt(r,l){1&r&&(e.TgZ(0,"div",51)(1,"p"),e._uU(2,"El peso remanente no puede ser menor que cero."),e.qZA()())}function ot(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"El formato del archivo debe ser PDF, JPEG o JPG."),e.qZA())}function nt(r,l){1&r&&(e.TgZ(0,"p"),e._uU(1,"El tama\xf1o del archivo no debe superar 1 MB."),e.qZA())}function rt(r,l){if(1&r&&(e.TgZ(0,"div",51),e.YNc(1,ot,2,0,"p",28),e.YNc(2,nt,2,0,"p",28),e.qZA()),2&r){const o=e.oxw();e.xp6(1),e.Q6J("ngIf",o.userForm.controls.attachment.errors.invalidFileType),e.xp6(1),e.Q6J("ngIf",o.userForm.controls.attachment.errors.invalidFileSize)}}let at=(()=>{class r{constructor(o,t,n,a,c){this.productorService=o,this.establishmentService=t,this.businessService=n,this.fb=a,this.cdr=c,this.disableWeightFields=!0,this.dbStatements=[],this.db=[],this.pos=1,this.business_name=[],this.establishment_name=[],this.material_name=[],this.treatment_name=[],this.years=[],this.state=[],this.cant=0,this.filteredStatements=[],this.selectedBusiness="-1",this.selectedMaterial="-1",this.selectedYear="-1",this.selectedTreatment="-1",this.selectedState="-1",this.selectAllChecked=!1,this.autoFilter=!0,this.isRemainingWeightNegative=!1,this.anyCheckboxSelected=!1,this.index=0,this.userForm=this.fb.group({invoiceNumber:["",[s.kI.required]],rut:["",[s.kI.required]],reciclador:["",[this.validRecycler]],treatmentType:["",[s.kI.required]],material:["",[s.kI.required]],entryDate:["",[s.kI.required,this.pastDateValidator()]],totalWeight:["",[s.kI.required,this.minStringValue(0),s.kI.pattern(/^[0-9]+(,[0-9]+)?$/)]],declarateWeight:[""],valuedWeight:["",[s.kI.required,this.minStringValue(0),s.kI.pattern(/^[0-9]+(,[0-9]+)?$/)]],remainingWeight:[""],asoc:[""],declarated:[""],attachment:[null,[s.kI.required,this.fileTypeValidator,this.fileSizeValidator]]}),this.dbBusiness=[],this.selectedDeclarationsCount=0,this.selectedWeight=0,this.isAnyCheckboxSelected=!1,this.businessNoFound=!0}ngOnInit(){this.userData=JSON.parse(sessionStorage.getItem("user")),this.loadStatements().then(()=>{this.filter(),this.pagTo(this.pos-1)}),this.userForm.controls.valuedWeight.disable(),this.userForm.controls.totalWeight.disable(),this.userForm.controls.reciclador.disable()}loadStatements(){return new Promise(o=>{const t=JSON.parse(sessionStorage.getItem("user")).ID_BUSINESS;i().fire({title:"Cargando Datos",text:"Se est\xe1n recuperando datos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1}),i().showLoading(),this.establishmentService.getDeclarationEstablishmentByIdGestor(t).subscribe(n=>{n.status&&(n.data=n.data.filter(a=>null!=a.TipoTratamiento),n.data=n.data.sort((a,c)=>{const u=new Date(c.FechaRetiro).getTime()-new Date(a.FechaRetiro).getTime();return 0===u?c.ID_DETAIL-a.ID_DETAIL:u}),n.data.forEach(a=>{a.isChecked=!1,-1==this.business_name.indexOf(a.NAME_BUSINESS)&&this.business_name.push(a.NAME_BUSINESS),-1==this.establishment_name.indexOf(a.NAME_ESTABLISHMENT_REGION)&&this.establishment_name.push(a.NAME_ESTABLISHMENT_REGION),-1==this.years.indexOf(a.FechaRetiroTipeada)&&this.years.push(a.FechaRetiroTipeada),-1==this.material_name.indexOf(a.PRECEDENCE)&&this.material_name.push(a.PRECEDENCE),-1===this.treatment_name.indexOf(a.TipoTratamiento)&&this.treatment_name.push(a.TipoTratamiento),-1==this.state.indexOf(a.STATE_GESTOR)&&this.state.push(a.STATE_GESTOR)}),this.years.sort((a,c)=>c-a),this.dbStatements=n.data,this.cant=Math.ceil(this.dbStatements.length/10),this.db=this.dbStatements.slice(10*(this.pos-1),10*this.pos).sort((a,c)=>{const u=new Date(c.FechaRetiro).getTime()-new Date(a.FechaRetiro).getTime();return 0===u?c.ID_DETAIL-a.ID_DETAIL:u}),i().close()),o()})})}openApprovalModal(){const o=this.db.filter(t=>t.isChecked&&0==t.STATE_GESTOR);o.length>0?(this.userForm.patchValue({declarated:this.selectedWeight,treatmentType:o[0].TipoTratamiento,material:o[0].PRECEDENCE}),document.getElementById("openModalButton")?.click()):console.log("error")}filter(o=!1){if(o&&!this.autoFilter)return;const t=parseInt(this.selectedState);this.filteredStatements=this.dbStatements.filter(n=>{const a=parseInt(n.STATE_GESTOR);return!("-1"!==this.selectedBusiness&&n.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedMaterial&&n.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedTreatment&&n.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedYear&&n.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&a!==t)}),this.db=this.filteredStatements.slice(0,10).sort((n,a)=>new Date(a.FechaRetiro).getTime()-new Date(n.FechaRetiro).getTime()||a.ID_DETAIL-n.ID_DETAIL),this.cant=Math.ceil(this.filteredStatements.length/10),this.selectedDeclarationsCount=0,this.selectedWeight=0,this.selectAllChecked=!1,this.filteredStatements.forEach(n=>{n.isChecked=0!=n.STATE_GESTOR&&n.isChecked}),this.anyCheckboxSelected=this.filteredStatements.some(n=>n.isChecked&&0==parseInt(n.STATE_GESTOR)),this.cdr.detectChanges()}filter_two(o=!1){if(o&&!this.autoFilter)return;const t=parseInt(this.selectedState);this.filteredStatements=this.dbStatements.filter(n=>{const a=parseInt(n.STATE_GESTOR);return!("-1"!==this.selectedBusiness&&n.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedMaterial&&n.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedTreatment&&n.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedYear&&n.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&a!==t)}),this.db=this.filteredStatements.slice(0,10).sort((n,a)=>new Date(a.FechaRetiro).getTime()-new Date(n.FechaRetiro).getTime()||a.ID_DETAIL-n.ID_DETAIL),this.cant=Math.ceil(this.filteredStatements.length/10)}updateFilters(){this.business_name=this.dbStatements.filter(o=>!("-1"!==this.selectedTreatment&&o.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedMaterial&&o.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedYear&&o.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&parseInt(o.STATE_GESTOR)!==parseInt(this.selectedState)&&void 0!==o.STATE_GESTOR)).map(o=>o.NAME_BUSINESS).filter((o,t,n)=>n.indexOf(o)===t),this.treatment_name=this.dbStatements.filter(o=>!("-1"!==this.selectedBusiness&&o.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedMaterial&&o.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedYear&&o.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&parseInt(o.STATE_GESTOR)!==parseInt(this.selectedState)&&void 0!==o.STATE_GESTOR)).map(o=>o.TipoTratamiento).filter((o,t,n)=>n.indexOf(o)===t),this.material_name=this.dbStatements.filter(o=>!("-1"!==this.selectedBusiness&&o.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedTreatment&&o.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedYear&&o.FechaRetiroTipeada!==this.selectedYear||"-1"!==this.selectedState&&parseInt(o.STATE_GESTOR)!==parseInt(this.selectedState)&&void 0!==o.STATE_GESTOR)).map(o=>o.PRECEDENCE).filter((o,t,n)=>n.indexOf(o)===t),this.years=this.dbStatements.filter(o=>!("-1"!==this.selectedBusiness&&o.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedTreatment&&o.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedMaterial&&o.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedState&&parseInt(o.STATE_GESTOR)!==parseInt(this.selectedState)&&void 0!==o.STATE_GESTOR)).map(o=>o.FechaRetiroTipeada).filter((o,t,n)=>n.indexOf(o)===t).sort((o,t)=>t-o),this.state=this.dbStatements.filter(o=>!("-1"!==this.selectedBusiness&&o.NAME_BUSINESS!==this.selectedBusiness||"-1"!==this.selectedTreatment&&o.TipoTratamiento!==this.selectedTreatment||"-1"!==this.selectedMaterial&&o.PRECEDENCE!==this.selectedMaterial||"-1"!==this.selectedYear&&o.FechaRetiroTipeada!==this.selectedYear)).map(o=>parseInt(o.STATE_GESTOR)).filter((o,t,n)=>n.indexOf(o)===t)}reset(){this.loadStatements().then(()=>{this.filter(),this.pagTo(this.pos-1)}),this.userForm.reset({reciclador:""})}reset_nocheck(){this.userForm.reset({reciclador:""})}pagTo(o){this.pos=o+1,this.db=this.filteredStatements.slice(10*o,10*(o+1)).sort((t,n)=>{const a=new Date(n.FechaRetiro).getTime()-new Date(t.FechaRetiro).getTime();return 0===a?n.ID_DETAIL-t.ID_DETAIL:a})}next(){this.pos>=this.cant||(this.pos++,this.db=this.filteredStatements.slice(10*(this.pos-1),10*this.pos).sort((o,t)=>{const n=new Date(t.FechaRetiro).getTime()-new Date(o.FechaRetiro).getTime();return 0===n?t.ID_DETAIL-o.ID_DETAIL:n}))}previus(){this.pos-1<=0||this.pos>=this.cant+1||(this.pos=this.pos-1,this.db=this.filteredStatements.slice(10*(this.pos-1),10*this.pos).sort((o,t)=>{const n=new Date(t.FechaRetiro).getTime()-new Date(o.FechaRetiro).getTime();return 0===n?t.ID_DETAIL-o.ID_DETAIL:n}))}setArrayFromNumber(){return new Array(this.cant)}visiblePageNumbers(){const o=this.setArrayFromNumber().length,t=[];if(o<=15)for(let n=0;n<o;n++)t.push(n);else{let n=Math.max(0,this.pos-Math.floor(7.5)),a=Math.min(o-1,n+14);a-n+1<15&&(a=o-1,n=Math.max(0,a-14));for(let c=n;c<=a;c++)t.push(c)}return t}getStateText(o){return 0===o?"Por aprobar":"Aprobado"}handleClick(o,t){this.dbBusiness=[],0===t&&(this.onMaterialTreatmentChange(o),this.index=o)}fileTypeValidator(o){const t=o.value;return t&&!["application/pdf","image/jpeg"].includes(t.type)?{invalidFileType:!0}:null}fileSizeValidator(o){const t=o.value;return t&&t.size>1048576?{invalidFileSize:!0}:null}onFileSelected(o){const t=o.target;if(t&&t.files&&t.files.length>0){const n=t.files[0];this.fileName=n.name,this.fileBuffer=n,this.selectedFile=t.files[0];const a=["pdf","jpeg","jpg"],c=this.selectedFile.name.split(".").pop()?.toLowerCase()||"";a.includes(c)?n.size>1048576?(this.userForm.controls.attachment.setErrors({invalidFileSize:!0}),this.userForm.controls.attachment.markAsTouched()):(this.userForm.controls.attachment.setErrors(null),this.userForm.controls.attachment.markAsTouched()):(this.userForm.controls.attachment.setErrors({invalidFileType:!0}),this.userForm.controls.attachment.markAsTouched())}else this.selectedFile=null}saveInvoice(o){var t=this;return(0,F.Z)(function*(){if(!t.selectedFile)return void console.error("No hay archivo seleccionado");let{rut:n,invoiceNumber:a,entryDate:c,valuedWeight:u,reciclador:b}=t.userForm.value;const q=t.userForm.controls.totalWeight.value.replace(",",".");u=parseFloat(u.replace(",",".")).toFixed(2);const I=t.filteredStatements.filter(A=>A.isChecked&&0==A.STATE_GESTOR),M=I.length>0?I:[t.db[o]];I.length>0&&(u=(parseFloat(u)/I.length).toFixed(2)),i().fire({title:"Cargando Datos",text:"Se est\xe1n recuperando datos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1});try{for(const A of M){const{TREATMENT_TYPE_NUMBER:E,PRECEDENCE_NUMBER:x,ID_DETAIL:D}=A;(yield t.establishmentService.saveInvoice(n,b,a,D,c,u,q,E,x,t.selectedFile).toPromise()).status&&t.updateItemState(D,u)}i().close(),yield t.showSuccessMessage(M.length>1)}catch(A){console.error("Error:",A)}})()}updateItemState(o,t){const n=this.db.find(a=>a.ID_DETAIL===o);n&&(n.STATE_GESTOR=1,n.VALUE_DECLARATE=t.replace(".",",")),this.cdr.detectChanges()}showSuccessMessage(o){return(0,F.Z)(function*(){yield i().fire({title:o?"Las facturas fueron guardadas exitosamente":"La factura fue guardada exitosamente",icon:"success",showConfirmButton:!0})})()}onChangeVAT(o){this.dbBusiness=[],this.businessService.getBusinessByVAT(o.value).subscribe(t=>{this.dbBusiness=t.status||[],this.userForm.controls.reciclador.enable(),this.businessNoFound=!1,0==this.dbBusiness.length?(this.businessNoFound=!0,this.userForm.controls.reciclador.setValue("")):(this.businessNoFound=!1,this.userForm.controls.reciclador.setValue(""))})}formatNumber(o){return null==o?"":Number.isInteger(o)?o.toString():o.toLocaleString("es")}numberOnly(o){["Backspace","Tab","End","Home","ArrowLeft","ArrowRight","Delete"].includes(o.key)||new RegExp("^[0-9]+$").test(o.key)||o.preventDefault()}onRUTChange(o){var t=this;return(0,F.Z)(function*(){const n=t.userForm.controls.invoiceNumber.value,a=t.db[o].TREATMENT_TYPE_NUMBER,c=t.db[o].PRECEDENCE_NUMBER;try{const u=yield t.establishmentService.getInovice(n,a,c).toPromise();u.status?(t.businessNoFound=!0,t.userForm.controls.totalWeight.setValue(t.formatNumber(u.data[0]?.invoice_value)),t.userForm.controls.declarateWeight.setValue(t.formatNumber(u.data[0].value_declarated)),t.userForm.controls.asoc.setValue(0!=t.selectedDeclarationsCount?u.data[0].num_asoc+t.selectedDeclarationsCount:u.data[0].num_asoc+1),parseInt(t.userForm.controls.asoc.value||"0")>1&&0==t.selectedDeclarationsCount?n?(t.userForm.controls.reciclador.setValue(u.data[0]?.NAME),t.userForm.controls.rut.setValue(u.data[0]?.RUT),t.userForm.controls.valuedWeight.enable(),t.userForm.controls.reciclador.enable(),t.userForm.controls.rut.enable()):(t.userForm.controls.reciclador.enable(),t.userForm.controls.rut.enable(),t.userForm.controls.reciclador.setValue(""),t.userForm.controls.rut.setValue(""),t.userForm.controls.valuedWeight.disable()):n?(t.userForm.controls.valuedWeight.enable(),t.userForm.controls.totalWeight.enable(),t.userForm.controls.reciclador.setValue(u.data[0]?.NAME),t.userForm.controls.rut.setValue(u.data[0]?.RUT),t.userForm.controls.reciclador.enable(),t.userForm.controls.rut.enable()):(t.userForm.controls.valuedWeight.disable(),t.userForm.controls.totalWeight.disable(),t.userForm.controls.reciclador.enable(),t.userForm.controls.rut.enable(),t.userForm.controls.reciclador.setValue(""),t.userForm.controls.rut.setValue(""))):(i().fire({icon:"error",text:u.msg}),t.userForm.controls.totalWeight.setValue(""),t.userForm.controls.declarateWeight.setValue(""),t.userForm.controls.reciclador.setValue(""),t.userForm.controls.rut.setValue(""),t.userForm.controls.asoc.setValue(""),t.userForm.controls.remainingWeight.setValue(""),t.userForm.controls.valuedWeight.disable(),t.userForm.controls.totalWeight.disable(),t.userForm.controls.reciclador.disable(),t.userForm.controls.rut.disable())}catch{t.userForm.controls.totalWeight.setValue(""),t.userForm.controls.declarateWeight.setValue(""),t.userForm.controls.reciclador.setValue(""),t.userForm.controls.rut.setValue(""),t.userForm.controls.asoc.setValue(""),t.userForm.controls.remainingWeight.setValue(""),t.userForm.controls.valuedWeight.disable(),t.userForm.controls.totalWeight.disable()}t.userForm.controls.valuedWeight.updateValueAndValidity(),t.userForm.controls.totalWeight.updateValueAndValidity()})()}onMaterialTreatmentChange(o){var t=this;return(0,F.Z)(function*(){t.userForm.controls.treatmentType.setValue(t.db[o].TipoTratamiento),t.userForm.controls.material.setValue(t.db[o].PRECEDENCE),t.userForm.controls.declarated.setValue(t.db[o].VALUE?.toString().replace(".",","))})()}verifyRut(o){return(0,f.validate)(o.value)?null:{rut:!0}}isTotalWeightEditable(){return!!this.userForm.controls.invoiceNumber.value&&!!this.userForm.controls.rut.value}getNumericValue(o){return o&&o.value?+o.value.toString().replace(",","."):0}calculateRemainingWeight(){const o=this.userForm.get("totalWeight"),t=this.userForm.get("valuedWeight"),n=this.userForm.get("declarateWeight"),b=this.getNumericValue(o)-this.getNumericValue(t)-this.getNumericValue(n);return this.isRemainingWeightNegative=b<0,b.toFixed(2).replace(".",",")}replaceDot(o){return 2==o.toString().split(".").length?o&&parseFloat(o).toFixed(2).replace(".",","):o&&o.toString().replace(".",",")}minStringValue(o){return t=>{if(!t.value)return null;const n=parseFloat(t.value.replace(",","."));return isNaN(n)||n<=o?{minStringValue:{value:t.value}}:null}}formatValue(o){return null==o?"":o%1==0?o.toString():o.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})}pastDateValidator(){return o=>{const t=new Date(o.value),n=new Date;return n.setHours(0,0,0,0),t>n?{futureDate:{value:o.value}}:null}}updateCheckboxSelection(){const o=this.filteredStatements.filter(n=>n.isChecked&&0==n.STATE_GESTOR);this.anyCheckboxSelected=o.length>0,this.selectedDeclarationsCount=o.length;let t=o.reduce((n,a)=>n+parseFloat(a.VALUE),0);if(this.selectedWeight=t%1==0?t.toLocaleString("es-ES"):t.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2}),o.length>0){const n=o[0];this.selectedTreatment=n.TipoTratamiento,this.selectedMaterial=n.PRECEDENCE,this.selectedState="0",this.disableFilters=!0,this.updateFilters()}else this.selectedTreatment="-1",this.selectedMaterial="-1",this.selectedState="-1",this.disableFilters=!1,this.filter_two(),this.updateFilters(),this.pagTo(0);this.isAnyCheckboxSelected=o.length>0,1==o.length&&(this.filter_two(),this.updateFilters(),this.pagTo(0))}selectAllCheckboxes(o){this.filteredStatements.forEach(t=>{0==t.STATE_GESTOR&&(t.isChecked=o)}),this.db=this.filteredStatements.slice(10*(this.pos-1),10*this.pos),this.updateCheckboxSelection()}onSelectAllCheckboxChange(o){const t=o.target;this.filteredStatements.forEach(c=>{0==c.STATE_GESTOR&&(c.isChecked=t.checked)}),this.db=this.filteredStatements.slice(10*(this.pos-1),10*this.pos);const n=this.filteredStatements.filter(c=>c.isChecked&&0==c.STATE_GESTOR);this.anyCheckboxSelected=this.filteredStatements.some(c=>c.isChecked&&0==c.STATE_GESTOR),this.cdr.detectChanges(),this.selectedDeclarationsCount=n.length,this.disableFilters=0!=this.selectedDeclarationsCount;let a=n.reduce((c,u)=>c+parseFloat(u.VALUE),0);this.selectedWeight=a%1==0?a.toLocaleString("es-ES"):a.toLocaleString("es-ES",{minimumFractionDigits:2,maximumFractionDigits:2})}validRecycler(o){return""===o.value?{invalidRecycler:!0}:null}}return r.\u0275fac=function(o){return new(o||r)(e.Y36(B.u),e.Y36(w.d),e.Y36(P.m),e.Y36(s.qu),e.Y36(e.sBO))},r.\u0275cmp=e.Xpm({type:r,selectors:[["app-statements"]],decls:210,vars:38,consts:[[1,"container","mt-4"],["aria-label","breadcrumb",1,"breadcrumbs","d-none","d-lg-block"],[1,"breadcrumb"],[1,"breadcrumb-item"],["href","#"],["aria-hidden","true",1,"fa","fa-home"],["aria-current","page",1,"breadcrumb-item","active"],[1,"declaracion"],[1,"box","box-form","mb-4"],[1,"row","align-items-end"],[1,"col-12","col-xl-2","mb-3","mb-xl-0"],[1,"form-label"],[1,"input-group"],["id","f_name",1,"form-select",3,"ngModel","ngModelChange","change"],["value","-1","selected",""],[3,"value",4,"ngFor","ngForOf"],["id","f_establishment",1,"form-select",3,"ngModel","disabled","ngModelChange","change"],["id","f_material",1,"form-select",3,"ngModel","disabled","ngModelChange","change"],["id","f_year",1,"form-select",3,"ngModel","ngModelChange","change"],["id","f_state",1,"form-select",3,"ngModel","disabled","ngModelChange","change"],[1,"btn","btn-primary","w-100",3,"click"],[1,"col-12","col-xl-3","mb-3","mb-xl-0"],["type","text","readonly","",1,"form-control",3,"ngModel","ngModelChange"],[1,"btn","btn-primary","w-100",3,"disabled","click"],[1,"table-responsive"],[1,"table","table-even","table-section","table-borderless","table-radius"],[1,"vertical-middle"],["type","checkbox",3,"disabled","ngModel","ngModelChange","change"],[4,"ngIf"],[4,"ngFor","ngForOf"],["aria-label","Navegaci\xf3n resultados"],[1,"pagination"],[1,"btn","btn-primary",3,"click"],["id","infoModal","tabindex","-1","aria-labelledby","exampleModalLabel","aria-hidden","true",1,"modal","fade",3,"hidden.bs.modal"],[1,"modal-dialog","modal-lg"],[1,"modal-content"],[1,"modal-header"],["id","exampleModalLabel",1,"modal-title","fs-5"],["type","button","data-bs-dismiss","modal","aria-label","Close",1,"btn-close"],[1,"modal-body"],[3,"formGroup"],["miFormulario","ngForm"],[1,"row","mb-3"],[1,"col-sm-4","col-form-label"],[1,"col-sm-8"],["type","text","placeholder","1234","formControlName","invoiceNumber",1,"form-control",3,"keypress","change"],["class","text-danger",4,"ngIf"],["type","text","placeholder","1-9","formControlName","rut",1,"form-control",3,"readonly","input"],["class","text-danger pl-0",4,"ngIf"],["type","text","class","form-control","placeholder","Ingrese Reciclador","formControlName","reciclador",4,"ngIf"],["class","form-select","formControlName","reciclador",3,"disabled",4,"ngIf"],[1,"text-danger","pl-0"],["type","text","placeholder","Tipo tratamiento","formControlName","treatmentType","readonly","",1,"form-control"],["type","text","placeholder","Tipo material","formControlName","material","readonly","",1,"form-control"],["type","date","placeholder","10/4/2023","formControlName","entryDate",1,"form-control"],["type","text","formControlName","totalWeight",1,"form-control"],["type","text","formControlName","declarated","readonly","",1,"form-control"],["type","text","formControlName","valuedWeight",1,"form-control"],["type","text","formControlName","remainingWeight","readonly","",1,"form-control",3,"value"],["type","text","formControlName","asoc","readonly","",1,"form-control"],["type","file","formControlName","attachment","id","inp_attachment","accept","application/pdf, image/jpeg","required","",1,"form-control",3,"change"],[1,"modal-footer"],["type","button","data-bs-dismiss","modal",1,"btn","btn-secondary",3,"click"],["type","button","data-bs-dismiss","modal",1,"btn","btn-primary",3,"disabled","click"],["id","openModalButton","data-bs-toggle","modal","data-bs-target","#infoModal",2,"display","none"],[3,"value"],[1,"example-section"],["data-bs-toggle","modal",1,"custom-cursor",3,"ngClass","click"],["aria-hidden","true",1,"fa","fa-check","fa-lg","fa-fw",3,"ngClass"],[1,"border","btn","btn-sm",3,"ngClass","click"],[1,"text-danger"],["type","text","placeholder","Ingrese Reciclador","formControlName","reciclador",1,"form-control"],["formControlName","reciclador",1,"form-select",3,"disabled"],["value",""]],template:function(o,t){if(1&o&&(e.TgZ(0,"div",0)(1,"nav",1)(2,"ol",2)(3,"li",3)(4,"a",4),e._UZ(5,"i",5),e._uU(6," Inicio"),e.qZA()(),e.TgZ(7,"li",6),e._uU(8,"Consulta de Declaraci\xf3n"),e.qZA()()(),e.TgZ(9,"section",7)(10,"h1"),e._uU(11,"Consulta de Declaraci\xf3n"),e.qZA(),e.TgZ(12,"div",8)(13,"div",9)(14,"div",10)(15,"label",11),e._uU(16,"Empresa CI:"),e.qZA(),e.TgZ(17,"div",12)(18,"select",13),e.NdJ("ngModelChange",function(a){return t.selectedBusiness=a})("change",function(){return t.updateFilters()}),e.TgZ(19,"option",14),e._uU(20,"Todos"),e.qZA(),e.YNc(21,j,2,2,"option",15),e.qZA()()(),e.TgZ(22,"div",10)(23,"label",11),e._uU(24,"Tipo de tratamiento:"),e.qZA(),e.TgZ(25,"div",12)(26,"select",16),e.NdJ("ngModelChange",function(a){return t.selectedTreatment=a})("change",function(){return t.updateFilters()}),e.TgZ(27,"option",14),e._uU(28,"Todos"),e.qZA(),e.YNc(29,z,2,2,"option",15),e.qZA()()(),e.TgZ(30,"div",10)(31,"label",11),e._uU(32,"Material:"),e.qZA(),e.TgZ(33,"div",12)(34,"select",17),e.NdJ("ngModelChange",function(a){return t.selectedMaterial=a})("change",function(){return t.updateFilters()}),e.TgZ(35,"option",14),e._uU(36,"Todos"),e.qZA(),e.YNc(37,V,2,2,"option",15),e.qZA()()(),e.TgZ(38,"div",10)(39,"label",11),e._uU(40,"Fecha de retiro:"),e.qZA(),e.TgZ(41,"div",12)(42,"select",18),e.NdJ("ngModelChange",function(a){return t.selectedYear=a})("change",function(){return t.updateFilters()}),e.TgZ(43,"option",14),e._uU(44,"Todos"),e.qZA(),e.YNc(45,S,2,2,"option",15),e.qZA()()(),e.TgZ(46,"div",10)(47,"label",11),e._uU(48,"Estado:"),e.qZA(),e.TgZ(49,"div",12)(50,"select",19),e.NdJ("ngModelChange",function(a){return t.selectedState=a})("change",function(){return t.updateFilters()}),e.TgZ(51,"option",14),e._uU(52,"Todos"),e.qZA(),e.YNc(53,Se,2,2,"option",15),e.qZA()()(),e.TgZ(54,"div",10)(55,"label",11),e._uU(56,"\xa0"),e.qZA(),e.TgZ(57,"div",12)(58,"button",20),e.NdJ("click",function(){return t.autoFilter=!1,t.filter(),t.pagTo(0),t.disableFilters=!1}),e._uU(59,"Mostrar"),e.qZA()()(),e.TgZ(60,"div",21)(61,"label",11),e._uU(62,"N\xfamero de declaraciones seleccionadas:"),e.qZA(),e.TgZ(63,"div",12)(64,"input",22),e.NdJ("ngModelChange",function(a){return t.selectedDeclarationsCount=a}),e.qZA()()(),e.TgZ(65,"div",21),e._UZ(66,"p"),e.TgZ(67,"label",11),e._uU(68,"Peso total declarado seleccionado (Kg):"),e.qZA(),e.TgZ(69,"div",12)(70,"input",22),e.NdJ("ngModelChange",function(a){return t.selectedWeight=a}),e.qZA()()(),e.TgZ(71,"div",10),e._UZ(72,"p"),e.TgZ(73,"label",11),e._uU(74,"\xa0"),e.qZA(),e.TgZ(75,"div",12)(76,"button",23),e.NdJ("click",function(){return t.openApprovalModal()}),e._uU(77," Aprobar Selecci\xf3n "),e.qZA()()()()(),e.TgZ(78,"div",24)(79,"table",25)(80,"thead",26)(81,"tr")(82,"th")(83,"input",27),e.NdJ("ngModelChange",function(a){return t.selectAllChecked=a})("change",function(a){return t.onSelectAllCheckboxChange(a)}),e.qZA(),e._uU(84," Seleccionar todo "),e.qZA(),e.TgZ(85,"th"),e._uU(86,"Empresa CI"),e.qZA(),e.TgZ(87,"th"),e._uU(88,"Establecimiento CI"),e.qZA(),e.TgZ(89,"th"),e._uU(90,"Tipo de tratamiento"),e.qZA(),e.TgZ(91,"th"),e._uU(92,"Material"),e.qZA(),e.TgZ(93,"th"),e._uU(94,"Subtipo"),e.qZA(),e.TgZ(95,"th"),e._uU(96,"Fecha Retiro"),e.qZA(),e.TgZ(97,"th"),e._uU(98,"Estado"),e.qZA(),e.TgZ(99,"th"),e._uU(100,"Peso Declarado"),e.qZA(),e.TgZ(101,"th"),e._uU(102,"Peso Valorizado"),e.qZA(),e.YNc(103,Ae,3,0,"ng-container",28),e.qZA()(),e.TgZ(104,"tbody"),e.YNc(105,Ne,25,16,"tr",29),e.qZA()()(),e.TgZ(106,"nav",30)(107,"ul",31)(108,"li")(109,"button",32),e.NdJ("click",function(){return t.pagTo(0)}),e._uU(110,"Primero"),e.qZA()(),e.TgZ(111,"li")(112,"button",32),e.NdJ("click",function(){return t.previus()}),e._uU(113,"Anterior"),e.qZA()(),e.YNc(114,ye,3,5,"li",29),e.TgZ(115,"li")(116,"button",32),e.NdJ("click",function(){return t.next()}),e._uU(117,"Siguiente"),e.qZA()(),e.TgZ(118,"li")(119,"button",32),e.NdJ("click",function(){return t.pagTo(t.cant-1)}),e._uU(120,"\xdaltimo"),e.qZA()()()()()(),e.TgZ(121,"div",33),e.NdJ("hidden.bs.modal",function(){return t.reset_nocheck()}),e.TgZ(122,"div",34)(123,"div",35)(124,"div",36)(125,"h1",37),e._uU(126,"Asignar factura reciclador"),e.qZA(),e._UZ(127,"button",38),e.qZA(),e.TgZ(128,"div",39)(129,"form",40,41)(131,"div",42)(132,"label",43),e._uU(133,"N\xfam. Factura Reciclador"),e.qZA(),e.TgZ(134,"div",44)(135,"input",45),e.NdJ("keypress",function(a){return t.numberOnly(a)})("change",function(){return t.onRUTChange(t.index)}),e.qZA(),e.YNc(136,Ue,2,1,"div",46),e.qZA()(),e.TgZ(137,"div",42)(138,"label",43),e._uU(139,"RUT Reciclador"),e.qZA(),e.TgZ(140,"div",44)(141,"input",47),e.NdJ("input",function(a){return t.onChangeVAT(a.target)}),e.qZA(),e.YNc(142,De,2,1,"div",48),e.qZA()(),e.TgZ(143,"div",42)(144,"label",43),e._uU(145,"Reciclador"),e.qZA(),e.TgZ(146,"div",44),e.YNc(147,Oe,1,0,"input",49),e.YNc(148,we,4,2,"select",50),e.TgZ(149,"div",51),e.YNc(150,Pe,2,0,"p",28),e.YNc(151,ke,2,0,"p",28),e.qZA()()(),e.TgZ(152,"div",42)(153,"label",43),e._uU(154,"Tipo Tratamiento"),e.qZA(),e.TgZ(155,"div",44),e._UZ(156,"input",52),e.YNc(157,Be,2,1,"div",48),e.qZA()(),e.TgZ(158,"div",42)(159,"label",43),e._uU(160,"Material"),e.qZA(),e.TgZ(161,"div",44),e._UZ(162,"input",53),e.YNc(163,$e,2,1,"div",48),e.qZA()(),e.TgZ(164,"div",42)(165,"label",43),e._uU(166,"Fecha Ingreso PR"),e.qZA(),e.TgZ(167,"div",44),e._UZ(168,"input",54),e.YNc(169,Ye,3,2,"div",46),e.qZA()(),e.TgZ(170,"div",42)(171,"label",43),e._uU(172,"Peso Total Factura Reciclador"),e.qZA(),e.TgZ(173,"div",44),e._UZ(174,"input",55),e.YNc(175,ze,4,3,"div",46),e.qZA()(),e.TgZ(176,"div",42)(177,"label",43),e._uU(178,"Peso Declarado"),e.qZA(),e.TgZ(179,"div",44),e._UZ(180,"input",56),e.qZA()(),e.TgZ(181,"div",42)(182,"label",43),e._uU(183,"Peso Valorizado"),e.qZA(),e.TgZ(184,"div",44),e._UZ(185,"input",57),e.YNc(186,et,4,3,"div",46),e.qZA()(),e.TgZ(187,"div",42)(188,"label",43),e._uU(189,"Peso Remanente"),e.qZA(),e.TgZ(190,"div",44),e._UZ(191,"input",58),e.YNc(192,tt,3,0,"div",48),e.qZA()(),e.TgZ(193,"div",42)(194,"label",43),e._uU(195,"Num. Declaraciones asociadas"),e.qZA(),e.TgZ(196,"div",44),e._UZ(197,"input",59),e.qZA()(),e.TgZ(198,"div",42)(199,"label",43),e._uU(200,"Adjuntar"),e.qZA(),e.TgZ(201,"div",44)(202,"input",60),e.NdJ("change",function(a){return t.onFileSelected(a)}),e.qZA(),e.YNc(203,rt,3,2,"div",48),e.qZA()()()(),e.TgZ(204,"div",61)(205,"button",62),e.NdJ("click",function(){return t.userForm.reset({reciclador:"0"})}),e._uU(206,"Volver"),e.qZA(),e.TgZ(207,"button",63),e.NdJ("click",function(){return t.saveInvoice(t.index),t.reset(),t.disableFilters=!1}),e._uU(208,"Guardar"),e.qZA()()()()(),e._UZ(209,"a",64)),2&o){let n,a;e.xp6(18),e.Q6J("ngModel",t.selectedBusiness),e.xp6(3),e.Q6J("ngForOf",t.business_name),e.xp6(5),e.Q6J("ngModel",t.selectedTreatment)("disabled",t.disableFilters),e.xp6(3),e.Q6J("ngForOf",t.treatment_name),e.xp6(5),e.Q6J("ngModel",t.selectedMaterial)("disabled",t.disableFilters),e.xp6(3),e.Q6J("ngForOf",t.material_name),e.xp6(5),e.Q6J("ngModel",t.selectedYear),e.xp6(3),e.Q6J("ngForOf",t.years),e.xp6(5),e.Q6J("ngModel",t.selectedState)("disabled",t.disableFilters),e.xp6(3),e.Q6J("ngForOf",t.state),e.xp6(11),e.Q6J("ngModel",t.selectedDeclarationsCount),e.xp6(6),e.Q6J("ngModel",t.selectedWeight),e.xp6(6),e.Q6J("disabled",0==t.selectedDeclarationsCount&&0==t.selectedWeight),e.xp6(7),e.Q6J("disabled",!t.isAnyCheckboxSelected)("ngModel",t.selectAllChecked),e.xp6(20),e.Q6J("ngIf",!t.anyCheckboxSelected),e.xp6(2),e.Q6J("ngForOf",t.db),e.xp6(9),e.Q6J("ngForOf",t.visiblePageNumbers()),e.xp6(15),e.Q6J("formGroup",t.userForm),e.xp6(7),e.Q6J("ngIf",t.userForm.controls.invoiceNumber.errors&&t.userForm.controls.invoiceNumber.touched),e.xp6(5),e.Q6J("readonly",t.userForm.controls.invoiceNumber.invalid),e.xp6(1),e.Q6J("ngIf",t.userForm.controls.rut.errors&&t.userForm.controls.rut.touched),e.xp6(5),e.Q6J("ngIf",t.businessNoFound||0===t.dbBusiness.length),e.xp6(1),e.Q6J("ngIf",!t.businessNoFound&&t.dbBusiness.length>0),e.xp6(2),e.Q6J("ngIf",(t.businessNoFound||0===t.dbBusiness.length)&&(null==(n=t.userForm.get("reciclador"))||null==n.errors?null:n.errors.invalidRecycler)),e.xp6(1),e.Q6J("ngIf",!t.businessNoFound&&t.dbBusiness.length>0&&(null==(a=t.userForm.get("reciclador"))||null==a.errors?null:a.errors.invalidRecycler)),e.xp6(6),e.Q6J("ngIf",t.userForm.controls.treatmentType.errors&&t.userForm.controls.treatmentType.touched),e.xp6(6),e.Q6J("ngIf",t.userForm.controls.material.errors&&t.userForm.controls.material.touched),e.xp6(6),e.Q6J("ngIf",t.userForm.controls.entryDate.errors&&t.userForm.controls.entryDate.touched),e.xp6(6),e.Q6J("ngIf",t.userForm.controls.totalWeight.errors&&t.userForm.controls.totalWeight.touched),e.xp6(11),e.Q6J("ngIf",t.userForm.controls.valuedWeight.errors&&t.userForm.controls.valuedWeight.touched),e.xp6(5),e.Q6J("value",t.calculateRemainingWeight()),e.xp6(1),e.Q6J("ngIf",t.isRemainingWeightNegative),e.xp6(11),e.Q6J("ngIf",t.userForm.controls.attachment.errors&&t.userForm.controls.attachment.touched),e.xp6(4),e.Q6J("disabled",t.userForm.invalid||t.isRemainingWeightNegative)}},dependencies:[Z.mk,Z.sg,Z.O5,s._Y,s.YN,s.Kr,s.Fj,s.Wl,s.EJ,s.JJ,s.JL,s.Q7,s.sg,s.u,s.On,Z.uU],styles:["[_nghost-%COMP%]{width:90%!important;padding:1%}.color-verde[_ngcontent-%COMP%]{color:green}.color-verde-opaco[_ngcontent-%COMP%]{color:#0080004d}.custom-cursor[_ngcontent-%COMP%]{cursor:pointer}.no-pointer[_ngcontent-%COMP%]{cursor:default}.example-section[_ngcontent-%COMP%]{margin:0 50px}"]}),r})();var it=p(263);let st=(()=>{class r{constructor(o,t,n){this.fb=o,this.authService=t,this.router=n,this.pos="right",this.horaIngreso=new Date,this.formData=this.fb.group({actual:["",[s.kI.required]],password:["",[s.kI.required,s.kI.minLength(3)]],repeatPassword:["",[s.kI.required,s.kI.minLength(3)]]})}ngOnInit(){this.userData=JSON.parse(sessionStorage.getItem("user")),this.horaIngreso=new Date(sessionStorage.getItem("horaIngreso")),localStorage.removeItem("statementsState")}btnrecovery(){const{actual:o,password:t,repeatPassword:n}=this.formData.value;this.authService.modifyPassword(t,n,o).subscribe({next:a=>{a.status?(i().fire({title:"Cambio de contrase\xf1a",text:"La contrase\xf1a fue cambiada exitosamente",icon:"success"}),this.router.navigate(["/gestor/home"])):(i().fire({title:"Validar informaci\xf3n",text:a.msg,icon:"error"}),this.formData.reset())},error:a=>{i().fire({title:"Formato inv\xe1lido",text:"Contrase\xf1a debe contener al menos 8 caracteres",icon:"error"})}})}displayModifyPassword(){this.pos="right"==this.pos?"down":"right"}}return r.\u0275fac=function(o){return new(o||r)(e.Y36(s.qu),e.Y36(it.e),e.Y36(N.F0))},r.\u0275cmp=e.Xpm({type:r,selectors:[["app-profile"]],decls:81,vars:16,consts:[[1,"container","mt-4"],[1,"mi-perfil"],[1,"box","box-mi-perfil","mb-5","d-flex","align-items-start"],[1,"list","list-data","list-data-title-green","column-md-2","gap-0","list-unstyled"],[1,"list-data__title"],[1,"list-data__text"],[1,"color-verde"],[1,"list","list-links","list-unstyled"],["id","accordionPanelsStayOpenExample",1,"accordion","accordion-flush"],[1,"accordion-item"],["id","panelsStayOpen-headingOne",1,"accordion-header"],["data-bs-toggle","collapse","data-bs-target","#panelsStayOpen-collapseOne",3,"click"],["aria-hidden","true"],["id","panelsStayOpen-collapseOne","aria-labelledby","panelsStayOpen-headingOne",1,"accordion-collapse","collapse"],[1,"accordion-body"],["autocomplete","off",1,"form-recovery",3,"formGroup"],[1,"mb-4"],[1,"input-group"],[1,"input-group-text","input-group-text-left"],["aria-hidden","true",1,"fa","fa-lock","fa-fw"],["type","password","id","password","formControlName","actual","placeholder","Contrase\xf1a actual",1,"form-control"],["type","password","id","password","formControlName","password","placeholder","Nueva contrase\xf1a",1,"form-control"],["type","password","id","repeatPassword","formControlName","repeatPassword","placeholder","Repetir contrase\xf1a",1,"form-control"],["type","button",1,"btn","btn-primary","btn-fa","w-100",3,"click"],["aria-hidden","true",1,"fa","fa-long-arrow-right","fa-fw"]],template:function(o,t){1&o&&(e.TgZ(0,"div",0)(1,"section",1)(2,"h1"),e._uU(3,"Mi Perfil"),e.qZA(),e.TgZ(4,"div",2)(5,"ul",3)(6,"li")(7,"span",4),e._uU(8,"Nombre Usuario"),e.qZA(),e.TgZ(9,"span",5),e._uU(10),e.qZA()(),e.TgZ(11,"li")(12,"span",4),e._uU(13,"Perfil"),e.qZA(),e.TgZ(14,"span",5),e._uU(15),e.qZA()(),e.TgZ(16,"li")(17,"span",4),e._uU(18,"Tel\xe9fono"),e.qZA(),e.TgZ(19,"span",5),e._uU(20),e.qZA()(),e.TgZ(21,"li")(22,"span",4),e._uU(23,"Correo"),e.qZA(),e.TgZ(24,"span",5),e._uU(25),e.qZA()(),e.TgZ(26,"li")(27,"span",4),e._uU(28,"Instituci\xf3n"),e.qZA(),e.TgZ(29,"span",5),e._uU(30),e.qZA()(),e.TgZ(31,"li")(32,"span",4),e._uU(33,"Cargo"),e.qZA(),e.TgZ(34,"span",5),e._uU(35),e.qZA()(),e.TgZ(36,"li")(37,"span",4),e._uU(38,"Tel\xe9fono Oficina"),e.qZA(),e.TgZ(39,"span",5),e._uU(40),e.qZA()(),e.TgZ(41,"li")(42,"span",4)(43,"b"),e._uU(44,"Fecha/ Hora ingreso"),e.qZA()(),e.TgZ(45,"span",5),e._uU(46),e.ALo(47,"date"),e.qZA()()()(),e.TgZ(48,"h2",6),e._uU(49,"Acciones"),e.qZA(),e.TgZ(50,"ul",7)(51,"div",8)(52,"div",9)(53,"h2",10)(54,"li",11),e.NdJ("click",function(){return t.displayModifyPassword()}),e.TgZ(55,"a")(56,"span"),e._uU(57,"Cambio de contrase\xf1a"),e.qZA(),e._UZ(58,"i",12),e.qZA()()(),e.TgZ(59,"div",13)(60,"div",14)(61,"form",15)(62,"div",16)(63,"div",17)(64,"button",18),e._UZ(65,"i",19),e.qZA(),e._UZ(66,"input",20),e.qZA()(),e.TgZ(67,"div",16)(68,"div",17)(69,"button",18),e._UZ(70,"i",19),e.qZA(),e._UZ(71,"input",21),e.qZA()(),e.TgZ(72,"div",16)(73,"div",17)(74,"button",18),e._UZ(75,"i",19),e.qZA(),e._UZ(76,"input",22),e.qZA()(),e.TgZ(77,"div",16)(78,"button",23),e.NdJ("click",function(){return t.btnrecovery()}),e._uU(79," Enviar "),e._UZ(80,"i",24),e.qZA()()()()()()()()()()),2&o&&(e.xp6(10),e.AsE("",t.userData.FIRST_NAME," ",t.userData.LAST_NAME,""),e.xp6(5),e.Oqu(t.userData.ROL_NAME),e.xp6(5),e.Oqu(t.userData.PHONE),e.xp6(5),e.Oqu(t.userData.EMAIL),e.xp6(5),e.Oqu(t.userData.BUSINESS.join(" || ")),e.xp6(5),e.Oqu(t.userData.POSITION),e.xp6(5),e.Oqu(t.userData.PHONE_OFFICE),e.xp6(6),e.Oqu(e.xi3(47,13,t.horaIngreso,"dd-MM-yyyy H:mm:s")),e.xp6(12),e.Gre("fa fa-chevron-",t.pos,""),e.xp6(3),e.Q6J("formGroup",t.formData))},dependencies:[s._Y,s.Fj,s.JJ,s.JL,s.sg,s.u,Z.uU]}),r})();var le=p(574),lt=p(3813);const ct=["fileInput"];function dt(r,l){if(1&r){const o=e.EpF();e.TgZ(0,"tr")(1,"td"),e._uU(2),e.qZA(),e.TgZ(3,"td"),e._uU(4),e.qZA(),e.TgZ(5,"td"),e._uU(6),e.qZA(),e.TgZ(7,"td"),e._uU(8),e.qZA(),e.TgZ(9,"td"),e._uU(10),e.qZA(),e.TgZ(11,"td"),e._uU(12),e.qZA(),e.TgZ(13,"td"),e._uU(14),e.qZA(),e.TgZ(15,"td"),e._uU(16),e.qZA(),e.TgZ(17,"td"),e._uU(18),e.qZA(),e.TgZ(19,"td"),e._uU(20),e.qZA(),e.TgZ(21,"td"),e._uU(22),e.qZA(),e.TgZ(23,"td"),e._uU(24),e.qZA(),e.TgZ(25,"td"),e._uU(26),e.qZA(),e.TgZ(27,"td"),e._uU(28),e.qZA(),e.TgZ(29,"td",26)(30,"input",27,17),e.NdJ("change",function(n){const c=e.CHM(o).index,u=e.oxw(2);return e.KtG(u.onInvoiceChange(n,c))}),e.qZA(),e.TgZ(32,"button",14),e.NdJ("click",function(){e.CHM(o);const n=e.MAs(31);return e.KtG(n.click())}),e._UZ(33,"i",18),e._uU(34," Cargar Factura "),e.qZA(),e.TgZ(35,"p"),e._uU(36),e.qZA()(),e.TgZ(37,"td"),e._UZ(38,"i",28),e.qZA()()}if(2&r){const o=l.$implicit,t=l.index,n=e.oxw(2);e.xp6(2),e.Oqu(o.nameBusiness),e.xp6(2),e.Oqu(o.establishment),e.xp6(2),e.Oqu(o.treatmentType),e.xp6(2),e.Oqu(o.material),e.xp6(2),e.Oqu(o.subMaterial),e.xp6(2),e.Oqu(o.withdrawalDate.replaceAll("/","-")),e.xp6(2),e.Oqu(o.numberInvoice),e.xp6(2),e.Oqu(o.vat),e.xp6(2),e.Oqu(o.vatCompanyName),e.xp6(2),e.Oqu(o.frontAdmissionDate),e.xp6(2),e.Oqu(o.totalWeightFormated),e.xp6(2),e.Oqu(o.declaratedWeightFormated),e.xp6(2),e.Oqu(o.valuedWeightFormated),e.xp6(2),e.Oqu(o.fixedRemainingWeight.replace(".",",")),e.xp6(8),e.Oqu(n.fileNames[t]),e.xp6(2),e.Q6J("ngClass",n.fileNames[t]?"color-verde":"color-verde-opaco")}}function ut(r,l){if(1&r){const o=e.EpF();e.TgZ(0,"div",20)(1,"table",21)(2,"thead")(3,"tr",22)(4,"th"),e._uU(5,"Empresa CI"),e.qZA(),e.TgZ(6,"th"),e._uU(7,"Establecimiento"),e.qZA(),e.TgZ(8,"th"),e._uU(9,"Tipo Tratamiento"),e.qZA(),e.TgZ(10,"th"),e._uU(11,"Material"),e.qZA(),e.TgZ(12,"th"),e._uU(13,"Subtipo"),e.qZA(),e.TgZ(14,"th"),e._uU(15,"Fecha Retiro"),e.qZA(),e.TgZ(16,"th"),e._uU(17,"N\xfam. Factura Reciclador"),e.qZA(),e.TgZ(18,"th"),e._uU(19,"Rut Reciclador"),e.qZA(),e.TgZ(20,"th"),e._uU(21,"Reciclador"),e.qZA(),e.TgZ(22,"th"),e._uU(23,"Fecha ingreso PR"),e.qZA(),e.TgZ(24,"th"),e._uU(25,"Peso Total"),e.qZA(),e.TgZ(26,"th"),e._uU(27,"Peso Declarado"),e.qZA(),e.TgZ(28,"th"),e._uU(29,"Peso Valorizado"),e.qZA(),e.TgZ(30,"th"),e._uU(31,"Peso Remanente"),e.qZA(),e.TgZ(32,"th"),e._uU(33,"Carga Factura"),e.qZA(),e.TgZ(34,"th"),e._uU(35,"Estado"),e.qZA()()(),e.TgZ(36,"tbody"),e.YNc(37,dt,39,16,"tr",23),e.qZA(),e.TgZ(38,"tbody")(39,"tr"),e._UZ(40,"td")(41,"td")(42,"td")(43,"td")(44,"td")(45,"td")(46,"td")(47,"td")(48,"td")(49,"td")(50,"td")(51,"td")(52,"td")(53,"td"),e.TgZ(54,"td",24)(55,"button",25),e.NdJ("click",function(){e.CHM(o);const n=e.oxw();return e.KtG(n.saveAllInvoices())}),e._uU(56," Finalizar "),e.qZA()()()()()()}if(2&r){const o=e.oxw();e.xp6(37),e.Q6J("ngForOf",o.allInvoices),e.xp6(18),e.Q6J("ngClass",o.verification==o.allInvoices.length?"":"disabled")}}let mt=(()=>{class r{constructor(o,t,n){this.establishmentService=o,this.managerService=t,this.businessService=n,this.dbBusiness=[],this.invoices=[],this.invoicesDuplicated=[],this.allInvoices=[],this.index=0,this.fileNames={},this.verification=0,this.fileToUpload={},this.wasteTypes={PapelCart\u00f3n:["Papel","Papel Compuesto (cemento)","Caja Cart\xf3n","Papel/Cart\xf3n Otro"],Metal:["Envase Aluminio","Malla o Reja (IBC)","Envase Hojalata","Metal Otro"],Pl\u00e1stico:["Pl\xe1stico Film Embalaje","Pl\xe1stico Envases R\xedgidos (Incl. Tapas)","Pl\xe1stico Sacos o Maxisacos","Pl\xe1stico EPS (Poliestireno Expandido)","Pl\xe1stico Zuncho","Pl\xe1stico Otro"],Madera:["Caja de Madera","Pallet de Madera"]}}ngOnInit(){this.userData=JSON.parse(sessionStorage.getItem("user")),localStorage.removeItem("statementsState")}downloadExcel(){const o=JSON.parse(sessionStorage.getItem("user")).ID_BUSINESS;i().fire({title:"Generando Excel",text:"Esto puede tardar varios minutos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1}),i().showLoading(),this.managerService.downloadExcelTemplateInvoice(o).subscribe({next:t=>{if(t){const n=new Blob([t],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8"});let a=document.createElement("a");a.href=window.URL.createObjectURL(n),a.download="carga masiva gestor",document.body.appendChild(a),a.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),a.remove(),window.URL.revokeObjectURL(a.href),i().close()}},error:t=>{if(t instanceof Blob){const n=new FileReader;n.onload=()=>{const a=n.result;try{const c=JSON.parse(a);!1===c.status&&c.message?i().fire({icon:"error",text:c.message}):i().fire({icon:"error",text:"Documento para carga masiva no disponible."})}catch{i().fire({icon:"error",text:"Error desconocido al procesar la respuesta."})}},n.readAsText(t)}else i().fire({icon:"error",text:"Error desconocido al procesar la respuesta."})}})}onFileChange(o){const n=o.target;if(1!==n.files.length)return void i().fire({icon:"error",text:"Solo puede cargar un archivo a la vez"});const a=n.files[0];if(!["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(a.type))return void i().fire({icon:"error",text:"Tipo de archivo incorrecto. Por favor, cargue un archivo Excel (.xls o .xlsx)"});if(n.files[0].size>1048576)return void i().fire({icon:"error",text:"Tama\xf1o del archivo excede el l\xedmite (1MB m\xe1ximo)."});const b=new FileReader;b.onload=q=>{const M=le.ij(q.target.result,{type:"binary"});if(!M.SheetNames.includes("Carga Masiva"))return void i().fire({icon:"error",text:'No se encontr\xf3 la hoja "Carga Masiva" en el archivo.'});const E=le.P6.sheet_to_json(M.Sheets["Carga Masiva"],{header:1});this.processData(E)},b.readAsBinaryString(a),this.resetFileInput()}resetFileInput(){this.fileInput.nativeElement.value=""}onInvoiceChange(o,t){const a=o.target;if(a.files.length>1)return void i().fire({icon:"error",text:"Solo puede cargar un archivo a la vez"});if(!["application/pdf","image/jpeg"].includes(a.files[0].type))return void i().fire({icon:"error",text:"Tipo de archivo incorrecto. Por favor, cargue un archivo v\xe1lido (.pdf, .jpeg o .jpg)"});if(a.files[0].size>1048576)return void i().fire({icon:"error",text:"Tama\xf1o del archivo excede el l\xedmite (1MB m\xe1ximo)."});const q=o.target.files[0];q&&(this.fileNames[t]=q.name,this.fileToUpload[t]=q,this.verification=Object.keys(this.fileNames).length),this.resetFileInput()}processData(o){var t=this;return(0,F.Z)(function*(){if(i().fire({title:"Procesando datos",text:"Se estan validando los datos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1}),i().showLoading(),0==o.length)return void i().fire({icon:"error",text:"Archivo inv\xe1lido. No tiene todas las columnas necesarias"});const n=o.slice(1).filter(m=>m.length>0&&m.some(d=>d)),a=[],c=[];if(0==n.length)return void i().fire({icon:"info",text:"Archivo inv\xe1lido, verifique que no est\xe9 vac\xedo."});if(13!=o[0].length)return void i().fire({icon:"error",text:"Archivo inv\xe1lido, no tiene todas las columnas necesarias."});const u=JSON.parse(sessionStorage.getItem("user")).ID_BUSINESS,q=(yield t.establishmentService.getDeclarationEstablishmentByIdGestor(u).toPromise()).data.filter(m=>0===m.STATE_GESTOR),I=yield t.managerService.getAllMaterials().toPromise(),M=yield t.managerService.getAllTreatments().toPromise(),A=new Set;for(let m=0;m<n.length;m++){const d=n[m],h=m+2;if(0==d.length&&0==m)return void i().fire({icon:"error",text:"Archivo vac\xedo"});const k=d[0];if(!k)return void i().fire({icon:"error",text:`Empresa CI no ingresado en la fila ${h}`});const W=d[1];if(!W)return void i().fire({icon:"error",text:`Establecimiento no ingresado en la fila ${h}`});const Y=d[2];if(!Y)return void i().fire({icon:"error",text:`Tipo de tratamiento no ingresado en la fila ${h}`});const Q=d[3];if(!Q)return void i().fire({icon:"error",text:`Material no ingresado en la fila ${h}`});const ce=d[4];if(!ce)return void i().fire({icon:"error",text:`Subtipo no ingresado en la fila ${h}`});const de=d[5];if(!de)return void i().fire({icon:"error",text:`Fecha retiro no ingresado en la fila ${h}`});const J=d[6];if(!J)return void i().fire({icon:"error",text:`Numero factura no ingresado en la fila ${h}`});if(J<=0)return void i().fire({icon:"error",text:`Numero factura ingresado en la fila ${h} debe ser mayor que cero`});const H=d[7];if(!H)return void i().fire({icon:"error",text:`RUT no ingresado en la fila ${h}`});let K;const X=I.status.find(_=>_.MATERIAL===Q);if(!X)return void i().fire({icon:"error",text:`No se encontr\xf3 ningun material con el nombre "${Q}" en la fila ${h}`});let ee;X&&(K=X.ID);const te=M.status.find(_=>_.NAME===Y);if(!te)return void i().fire({icon:"error",text:`No se encontr\xf3 ningun tipo de tratamiento con el nombre "${Y}" en la fila ${h}`});te&&(ee=te.ID);const ue=d[8];if(!ue)return void i().fire({icon:"error",text:`Reciclador no ingresado en la fila ${h}`});let me;me=d[8];const oe=d[9];if(!oe)return void i().fire({icon:"error",text:`Fecha ingreso PR no ingresado en la fila ${h}`});const pe=t.isValidDate(oe);if(!pe.valid)return void i().fire({icon:"error",text:`Error en la fila ${h}. ${pe.message}`});let C,y,$;const G=yield t.establishmentService.getInovice(J,ee,K).toPromise();if(!G.status)return void i().fire({icon:"error",text:`La fila ${h} tiene el siguiente error: `+G.msg});if(C=t.formatNumber(G.data[0]?.invoice_value),$=t.formatNumber(G.data[0].value_declarated),0==C&&!d[10])return void i().fire({icon:"error",text:`Peso total no ingresado en la fila ${h}`});if(0==C&&(C=d[10]),0!==C&&C!==d[10])return void i().fire({icon:"info",text:`La factura con numero ${J} de la fila ${h} ya cuenta con datos existentes, favor de ingresar el peso total registrado previamente (${C})`});const _t=C.replace(",","."),he=parseFloat(_t);if(isNaN(he))return void i().fire({icon:"error",text:`Peso total ingresado en la fila ${h} no es v\xe1lido, debe ser solo n\xfameros y con comas.`});if(he<=0)return void i().fire({icon:"error",text:`Peso total ingresado en la fila ${h} debe ser mayor que cero.`});if(y=d[11],0==y&&!d[11])return void i().fire({icon:"error",text:`Peso declarado no ingresado en la fila ${h}`});0==y&&(y=d[11]);const O=d[12];if(!O)return void i().fire({icon:"error",text:`Peso valorizado no ingresado en la fila ${h}`});const Tt=O.replace(",","."),ge=parseFloat(Tt);if(isNaN(ge))return void i().fire({icon:"error",text:`Peso valorizado ingresado en la fila ${h} no es v\xe1lido, debe ser solo n\xfameros y con comas.`});if(ge<=0)return void i().fire({icon:"error",text:`Peso valorizado ingresado en la fila ${h} debe ser mayor que cero.`});const fe=parseFloat(C.toString().replace(",",".")),_e=parseFloat(O.toString().replace(",","."));let L;if(0!==$){const g=fe-parseFloat($.toString().replace(",",".")),Ze=g-_e;if(L=Ze.toFixed(2).replace(".",","),Ze<0)return void i().fire({icon:"error",text:`Peso remanente calculado en la fila ${h} no puede ser menor que cero.\n ${g} - ${O}  = ${L}`})}if(0==$){const _=fe-_e;if(L=_.toFixed(2).replace(".",","),_<0)return void i().fire({icon:"error",text:`Peso remanente calculado en la fila ${h} no puede ser menor que cero.\n ${C} - ${O}  = ${L}`})}for(let _=m+1;_<n.length;_++){const g=n[_];if(g[2]!==d[2]&&g[3]===d[3]&&g[6]===d[6])return void i().fire({icon:"info",text:`Distintos tipos de tratamiento con el mismo tipo de material y N\xfam de factura reciclador en las filas ${m+2} y ${_+2}`});if(g[2]===d[2]&&g[3]!==d[3]&&g[6]===d[6])return void i().fire({icon:"info",text:`Distintos tipos de material con el mismo tipo de tratamiento y N\xfam de factura reciclador en las filas ${m+2} y ${_+2}`});if(g[2]!==d[2]&&g[3]!==d[3]&&g[6]===d[6])return void i().fire({icon:"info",text:`Distintos tipos de tratamiento y material con el mismo N\xfam de factura reciclador en las filas ${m+2} y ${_+2}`});if(g[2]===d[2]&&g[3]===d[3]&&g[6]===d[6]&&g[10]!==d[10])return void i().fire({icon:"info",text:`Ingresar el mismo peso total para todas las facturas iguales con numero ${d[6]}`});g[2]===d[2]&&g[3]===d[3]&&g[6]===d[6]&&g[10]===d[10]&&(A.add(d),A.add(g))}const Te=d[13],ne=oe.split("/"),ve=new Date(`${ne[2]}-${ne[1]}-${ne[0]}`).toISOString().split("T")[0],re=ve.split("-"),bt=`${re[2]}-${re[1]}-${re[0]}`;if(!q.find(_=>_.ID_DETAIL==parseInt(Te)))return void i().fire({icon:"error",text:`No se encontr\xf3 ninguna factura pendiente en la base de datos con los registros de la fila ${h}`});const Zt=parseFloat(C.replace(",",".")).toFixed(2).replace(".",",").toString(),St=parseFloat(O.replace(",",".")).toFixed(2).replace(".",",").toString();let ae;"number"==typeof y&&(ae=parseFloat(y.toString().replace(",",".")).toFixed(2).replace(".",",").toString()),"string"==typeof y&&(ae=parseFloat(y.replace(",",".")).toFixed(2).replace(".",",").toString());const be={nameBusiness:k,idBusiness:me,establishment:W,treatmentType:Y,material:Q,subMaterial:ce,withdrawalDate:de,numberInvoice:J,vat:H,vatCompanyName:ue,backAdmissionDate:ve,totalWeight:C,declaratedWeight:y,valuedWeight:O,fixedRemainingWeight:L,idDetail:Te,frontAdmissionDate:bt,totalWeightFormated:Zt,valuedWeightFormated:St,declaratedWeightFormated:ae,declaratedWeightResponse:$,materialTypeNum:K,treatmentTypeNum:ee};let ie=!1;for(const _ of A)_.includes(H)&&(ie=!0);0==ie&&a.push(be),1==ie&&c.push(be)}const E={};let x=null,D=null;for(const m of c){const d=`${m.numberInvoice}`;E[d]||(E[d]={tipo_tratamiento:m.treatmentType,material:m.material,numero_factura:m.numberInvoice,remanente_total:0}),null===x&&null===D&&(x=0!==parseFloat(m.declaratedWeightResponse)?parseFloat(m.totalWeight.toString().replace(",","."))-parseFloat(m.declaratedWeightResponse.toString().replace(",",".")):parseFloat(m.totalWeight.replace(",",".")),D=m.numberInvoice),D!=m.numberInvoice&&(x=0!==parseFloat(m.declaratedWeightResponse)?parseFloat(m.totalWeight.toString().replace(",","."))-parseFloat(m.declaratedWeightResponse.toString().replace(",",".")):parseFloat(m.totalWeight.replace(",",".")),D=m.numberInvoice),x-=parseFloat(m.valuedWeight.replace(",",".")),m.fixedRemainingWeight=x.toFixed(2).replace(".",",").toString(),E[d].remanente_total=x}for(const m in E)if(E.hasOwnProperty(m)){const d=E[m].remanente_total;if(d<0)return void i().fire({icon:"error",text:`Los remanentes totales para las facturas con numero ${m} son menores a cero: ${d}`})}t.invoices=a,t.invoicesDuplicated=c,t.allInvoices=Array.from([...a,...c]),i().close()})()}saveAllInvoices(){var o=this;return(0,F.Z)(function*(){i().fire({title:"Ingresando datos",text:"Se estan cargando los datos",timerProgressBar:!0,showConfirmButton:!1,allowEscapeKey:!1,allowOutsideClick:!1}),i().showLoading();let t=!1;for(let n=0;n<o.allInvoices.length;n++){const a=o.allInvoices[n];if(o.allInvoices.length==Object.keys(o.fileNames).length&&o.fileNames[n])try{if(!(yield Promise.race([o.establishmentService.saveInvoice(a.vat,a.idBusiness,a.numberInvoice,a.idDetail,a.backAdmissionDate,a.valuedWeight.replace(",","."),a.totalWeight.replace(",","."),a.treatmentTypeNum,a.materialTypeNum,o.fileToUpload[n]).toPromise(),new Promise((u,b)=>{setTimeout(()=>b(new Error("Timeout")),3e4)})])).status)return t=!0,o.allInvoices=[],i().close(),void i().fire({icon:"error",text:"Ha habido un error y el proceso se ha detenido, consulte m\xe1s tarde el estado de sus declaraciones para ver cuales fueron exitosamente aprobadas y cuales no."})}catch(c){if("Timeout"===c.message)return t=!0,o.allInvoices=[],i().close(),void i().fire({icon:"error",text:"Ha habido un error y el proceso se ha detenido, consulte m\xe1s tarde el estado de sus declaraciones para ver cuales fueron exitosamente aprobadas y cuales no."});throw t=!0,o.allInvoices=[],i().close(),i().fire({icon:"error",text:"Ha habido un error y el proceso se ha detenido, consulte m\xe1s tarde el estado de sus declaraciones para ver cuales fueron exitosamente aprobadas y cuales no."}),c}}o.allInvoices=[],t||(i().close(),i().fire({icon:"success",text:"Sus facturas han sido ingresadas correctamente"}))})()}formatNumber(o){return null==o?0:Number.isInteger(o)?o.toString():o.toLocaleString("es")}isValidDate(o){if(typeof o>"u"||""===o.trim())return{valid:!1,message:"Fecha no puede estar vac\xeda."};const t=o.split("/");if(3!==t.length||isNaN(+t[0])||isNaN(+t[1])||isNaN(+t[2]))return{valid:!1,message:"Formato de la fecha es incorrecto. Formato requerido: DD/MM/AAAA"};const n=new Date(+t[2],+t[1]-1,+t[0]),a=new Date;return a.setHours(0,0,0,0),n>a?{valid:!1,message:"Fecha no debe ser futura."}:n.getDate()!==+t[0]||n.getMonth()!==+t[1]-1||n.getFullYear()!==+t[2]?{valid:!1,message:"Fecha proporcionada no es v\xe1lida."}:{valid:!0,message:""}}}return r.\u0275fac=function(o){return new(o||r)(e.Y36(w.d),e.Y36(lt.b),e.Y36(P.m))},r.\u0275cmp=e.Xpm({type:r,selectors:[["app-bulk-upload"]],viewQuery:function(o,t){if(1&o&&e.Gf(ct,5),2&o){let n;e.iGM(n=e.CRH())&&(t.fileInput=n.first)}},decls:28,vars:1,consts:[[1,"container","mt-4"],["aria-label","breadcrumb",1,"breadcrumbs","d-none","d-lg-block"],[1,"breadcrumb"],[1,"breadcrumb-item"],["href","#"],["aria-hidden","true",1,"fa","fa-home"],["aria-current","page",1,"breadcrumb-item","active"],[1,"declaracion"],[1,"d-sm-flex","justify-content-between","mb-3","mb-md-0"],[1,"box","box-form","mb-4"],[1,"row","align-items-end"],[1,"col-12","col-xl-12"],[1,"row"],[1,"col-6"],[1,"btn","btn-primary","col-12",3,"click"],[1,"fas","fa-download"],["type","file","id","file-input","accept",".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",2,"display","none",3,"change"],["fileInput",""],[1,"fas","fa-upload"],["class","box box-form mb-12",4,"ngIf"],[1,"box","box-form","mb-12"],[1,"table","table-even","table-section","table-borderless","table-radius"],["align","center"],[4,"ngFor","ngForOf"],["colspan","2"],[1,"btn","btn-primary","col-12",3,"ngClass","click"],[2,"width","1000px"],["type","file","id","file-input","accept",".pdf,.jpeg,.jpg",2,"display","none",3,"change"],["aria-hidden","true","id","submit",1,"fa","fa-check","fa-lg","fa-fw",3,"ngClass"]],template:function(o,t){if(1&o){const n=e.EpF();e.TgZ(0,"div",0)(1,"nav",1)(2,"ol",2)(3,"li",3)(4,"a",4),e._UZ(5,"i",5),e._uU(6," Inicio"),e.qZA()(),e.TgZ(7,"li",6),e._uU(8,"Carga Masiva Factura Reciclador"),e.qZA()()(),e.TgZ(9,"section",7)(10,"h1"),e._uU(11,"Carga Masiva Factura Reciclador"),e.qZA(),e._UZ(12,"div",8),e.TgZ(13,"div",9)(14,"div",10)(15,"div",11)(16,"div",12)(17,"div",13)(18,"button",14),e.NdJ("click",function(){return t.downloadExcel()}),e._UZ(19,"i",15),e._uU(20," Descargar declaraciones pendientes por aprobar "),e.qZA()(),e.TgZ(21,"div",13)(22,"input",16,17),e.NdJ("change",function(c){return t.onFileChange(c)}),e.qZA(),e.TgZ(24,"button",14),e.NdJ("click",function(){e.CHM(n);const c=e.MAs(23);return e.KtG(c.click())}),e._UZ(25,"i",18),e._uU(26," Cargar declaraciones "),e.qZA()()()()()(),e.YNc(27,ut,57,2,"div",19),e.qZA()()}2&o&&(e.xp6(27),e.Q6J("ngIf",t.allInvoices.length>0))},dependencies:[Z.mk,Z.sg,Z.O5],styles:["[_nghost-%COMP%]{width:90%!important;padding:1%}.color-verde[_ngcontent-%COMP%]{color:green}.color-verde-opaco[_ngcontent-%COMP%]{color:#0080004d}.circle[_ngcontent-%COMP%]{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:5px}.green-circle[_ngcontent-%COMP%]{background-color:green}.red-circle[_ngcontent-%COMP%]{background-color:red}"]}),r})();var pt=p(9314);const ht=[{path:"",component:U.$,children:[{path:"home",component:T},{path:"statements",component:at},{path:"profile",component:st},{path:"faq",component:pt.v},{path:"bulk-upload-invoice",component:mt},{path:"**",redirectTo:"home",pathMatch:"full"}]}];let gt=(()=>{class r{}return r.\u0275fac=function(o){return new(o||r)},r.\u0275mod=e.oAB({type:r}),r.\u0275inj=e.cJS({imports:[N.Bz.forChild(ht),N.Bz]}),r})(),ft=(()=>{class r{}return r.\u0275fac=function(o){return new(o||r)},r.\u0275mod=e.oAB({type:r}),r.\u0275inj=e.cJS({imports:[Z.ez,gt,s.UX,s.u5]}),r})()}}]);